# –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–∏–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–π –≤ bot.py

## üìã –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π –∑–∞–∫—Ä—ã—Ç–∏—è

### 1. `db_close_position` (—Å—Ç—Ä–æ–∫–∞ 525)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ë–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ –≤ –ë–î
- –ü–µ—Ä–µ–Ω–æ—Å–∏—Ç –ø–æ–∑–∏—Ü–∏—é –∏–∑ `positions` –≤ `history`
- –£–¥–∞–ª—è–µ—Ç –ø–æ–∑–∏—Ü–∏—é –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö
- –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
- **–ù–ï –æ–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å –∏ total_profit** (—ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –≤—ã–∑—ã–≤–∞—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–µ–π)

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `pos_id`: ID –ø–æ–∑–∏—Ü–∏–∏
- `exit_price`: –¶–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏—è
- `pnl`: –ü—Ä–∏–±—ã–ª—å/—É–±—ã—Ç–æ–∫
- `reason`: –ü—Ä–∏—á–∏–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏—è (MANUAL, CLOSE_ALL, BYBIT_SYNC, TP, SL, TP3, ORPHAN_SYNC, EARLY_EXIT_*, BYBIT_TP, BYBIT_SL)

---

### 2. `close_trade` (—Å—Ç—Ä–æ–∫–∞ 4782)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –†—É—á–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –æ–¥–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –Ω–∞ Bybit —á–µ—Ä–µ–∑ `hedge_close` (–µ—Å–ª–∏ —Ö–µ–¥–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ)
- –ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∑–∞–∫—Ä—ã—Ç–∏—è —Å Bybit
- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç PnL –ª–æ–∫–∞–ª—å–Ω–æ
- –û–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å –∏ total_profit
- –í—ã–∑—ã–≤–∞–µ—Ç `db_close_position`

**–§–æ—Ä–º—É–ª—ã:**
```python
# PnL —Ä–∞—Å—á–µ—Ç
if direction == "LONG":
    pnl_percent = (close_price - entry_price) / entry_price
else:
    pnl_percent = (entry_price - close_price) / entry_price
pnl = amount * LEVERAGE * pnl_percent - commission

# –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤
returned = amount + pnl

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
user['balance'] = sanitize_balance(user['balance'] + returned)
user['total_profit'] = (user.get('total_profit', 0) or 0) + pnl
```

**–°—Ç—Ä–æ–∫–∏:** 4782-4936

---

### 3. `close_all_trades` (—Å—Ç—Ä–æ–∫–∞ 3688)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ó–∞–∫—Ä—ã—Ç—å –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ –ø–æ —Å–∏–º–≤–æ–ª—É –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –Ω–∞ Bybit
- –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –Ω–∞ Bybit –ø–æ –≥—Ä—É–ø–ø–∞–º
- –ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã –∑–∞–∫—Ä—ã—Ç–∏—è
- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç PnL –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏
- –°—É–º–º–∏—Ä—É–µ—Ç –≤—Å–µ PnL –∏ –≤–æ–∑–≤—Ä–∞—Ç—ã
- –û–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å –∏ total_profit –æ–¥–∏–Ω —Ä–∞–∑ –¥–ª—è –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π

**–§–æ—Ä–º—É–ª—ã:**
```python
# PnL —Ä–∞—Å—á–µ—Ç (–¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏)
if direction == "LONG":
    pnl_percent = (close_price - entry) / entry
else:
    pnl_percent = (entry - close_price) / entry
pnl = amount * LEVERAGE * pnl_percent - commission

# –í–æ–∑–≤—Ä–∞—Ç (–¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏)
returned = amount + pnl

# –ò—Ç–æ–≥–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
total_pnl += pnl  # –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏
total_returned += returned  # –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏
user['balance'] = sanitize_balance(user['balance'] + total_returned)
user['total_profit'] += total_pnl
```

**–°—Ç—Ä–æ–∫–∏:** 3688-3845

---

### 4. `close_symbol_trades` (—Å—Ç—Ä–æ–∫–∞ 3576)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ó–∞–∫—Ä—ã—Ç—å –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —Å–∏–º–≤–æ–ª—É
- –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –∫–∞–∂–¥—É—é –ø–æ–∑–∏—Ü–∏—é –Ω–∞ Bybit –æ—Ç–¥–µ–ª—å–Ω–æ
- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç PnL –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏
- –û–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å –∏ total_profit –≤ —Ü–∏–∫–ª–µ (–¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏)

**–§–æ—Ä–º—É–ª—ã:**
```python
# PnL —Ä–∞—Å—á–µ—Ç
if direction == "LONG":
    pnl = (real_price - entry) / entry * amount * LEVERAGE
else:
    pnl = (entry - real_price) / entry * amount * LEVERAGE
pnl -= commission

# –í–æ–∑–≤—Ä–∞—Ç –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–≤ —Ü–∏–∫–ª–µ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏)
returned = amount + pnl
user['balance'] = sanitize_balance(user['balance'] + returned)
user['total_profit'] += pnl
```

**–°—Ç—Ä–æ–∫–∏:** 3576-3686

---

### 5. `close_stacked_trades` (—Å—Ç—Ä–æ–∫–∞ 4938)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ó–∞–∫—Ä—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç–∞–∫–Ω—É—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π –æ–¥–Ω–∏–º –Ω–∞–∂–∞—Ç–∏–µ–º
- –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç –ø–æ —Å–∏–º–≤–æ–ª—É –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –Ω–∞ Bybit
- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç PnL –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏
- –°—É–º–º–∏—Ä—É–µ—Ç –≤—Å–µ PnL –∏ –≤–æ–∑–≤—Ä–∞—Ç—ã
- –û–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å –∏ total_profit –æ–¥–∏–Ω —Ä–∞–∑

**–§–æ—Ä–º—É–ª—ã:** –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ `close_all_trades`

**–°—Ç—Ä–æ–∫–∏:** 4938-5077

---

### 6. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –≤ `update_positions` (—Å—Ç—Ä–æ–∫–∞ ~5600)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å Bybit

**–°—Ü–µ–Ω–∞—Ä–∏–∏:**

#### 6.1. –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (—Å—Ç—Ä–æ–∫–∞ 3442-3496)
- –û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –∑–∞–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ Bybit
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π PnL —Å Bybit (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
- –û–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å –∏ total_profit

**–§–æ—Ä–º—É–ª—ã:**
```python
returned = amount + real_pnl  # real_pnl –±–µ—Ä–µ—Ç—Å—è —Å Bybit –∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π
user['balance'] = sanitize_balance(user['balance'] + returned)
user['total_profit'] += real_pnl
```

**–°—Ç—Ä–æ–∫–∏:** 3442-3496

#### 6.2. –ß–∞—Å—Ç–∏—á–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –Ω–∞ –ø–æ–ª–ø—É—Ç–∏ –∫ TP (—Å—Ç—Ä–æ–∫–∞ 5734-5771)
- –ó–∞–∫—Ä—ã–≤–∞–µ—Ç 25% –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ –ø–æ–ª–ø—É—Ç–∏ –∫ TP1
- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —á–∞—Å—Ç–∏—á–Ω—ã–π PnL
- –û–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å –∏ total_profit
- –£–º–µ–Ω—å—à–∞–µ—Ç `amount` –ø–æ–∑–∏—Ü–∏–∏

**–§–æ—Ä–º—É–ª—ã:**
```python
if direction == "LONG":
    partial_pnl = (current - entry) / entry * partial_close_amount * LEVERAGE
else:
    partial_pnl = (entry - current) / entry * partial_close_amount * LEVERAGE

returned = partial_close_amount + partial_pnl
user['balance'] = sanitize_balance(user['balance'] + returned)
user['total_profit'] += partial_pnl
pos['amount'] -= partial_close_amount
```

**–°—Ç—Ä–æ–∫–∏:** 5734-5771

#### 6.3. –†–∞–Ω–Ω–∏–π –≤—ã—Ö–æ–¥ (EARLY_EXIT) (—Å—Ç—Ä–æ–∫–∞ 5907-5963)
- –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é –ø—Ä–∏ –ø—Ä–∏–∑–Ω–∞–∫–∞—Ö —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞
- –ú–æ–∂–µ—Ç –±—ã—Ç—å —á–∞—Å—Ç–∏—á–Ω—ã–º –∏–ª–∏ –ø–æ–ª–Ω—ã–º
- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç PnL –æ—Ç –∑–∞–∫—Ä—ã–≤–∞–µ–º–æ–π —á–∞—Å—Ç–∏

**–§–æ—Ä–º—É–ª—ã:**
```python
close_amount = amount * close_percent
if direction == "LONG":
    exit_pnl = (current - entry) / entry * close_amount * LEVERAGE
else:
    exit_pnl = (entry - current) / entry * close_amount * LEVERAGE

returned = close_amount + exit_pnl
user['balance'] = sanitize_balance(user['balance'] + returned)
user['total_profit'] += exit_pnl
```

**–°—Ç—Ä–æ–∫–∏:** 5907-5963

#### 6.4. TP1 - –∑–∞–∫—Ä—ã—Ç–∏–µ 50% (—Å—Ç—Ä–æ–∫–∞ 5985-6045)
- –ó–∞–∫—Ä—ã–≤–∞–µ—Ç 50% –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ TP1
- –ü–µ—Ä–µ–º–µ—â–∞–µ—Ç SL –≤ –±–µ–∑—É–±—ã—Ç–æ–∫
- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —á–∞—Å—Ç–∏—á–Ω—ã–π PnL

**–§–æ—Ä–º—É–ª—ã:**
```python
close_percent = 0.50
close_amount = amount * close_percent
if direction == "LONG":
    partial_pnl = (current - entry) / entry * close_amount * LEVERAGE
else:
    partial_pnl = (entry - current) / entry * close_amount * LEVERAGE

returned = close_amount + partial_pnl
user['balance'] = sanitize_balance(user['balance'] + returned)
user['total_profit'] += partial_pnl
pos['amount'] = remaining_amount  # —É–º–µ–Ω—å—à–∞–µ–º –Ω–∞ close_amount
```

**–°—Ç—Ä–æ–∫–∏:** 5985-6045

#### 6.5. TP2 - –∑–∞–∫—Ä—ã—Ç–∏–µ 30% –æ—Ç –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è (—Å—Ç—Ä–æ–∫–∞ 6047-6110)
- –ó–∞–∫—Ä—ã–≤–∞–µ—Ç 30% –æ—Ç –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è 50% (—Ç.–µ. 60% –æ—Ç –∏—Å—Ö–æ–¥–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏)
- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —á–∞—Å—Ç–∏—á–Ω—ã–π PnL

**–§–æ—Ä–º—É–ª—ã:**
```python
close_percent = 0.30 / 0.50  # 60% –æ—Ç —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏
close_amount = amount * close_percent
# PnL —Ä–∞—Å—á–µ—Ç –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ TP1
```

**–°—Ç—Ä–æ–∫–∏:** 6047-6110

#### 6.6. TP3 –∏–ª–∏ SL - –ø–æ–ª–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ (—Å—Ç—Ä–æ–∫–∞ 6112-6200)
- –ü–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π PnL —Å Bybit (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–π PnL

**–§–æ—Ä–º—É–ª—ã:**
```python
# –ü—ã—Ç–∞–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π PnL —Å Bybit
# –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π pos['pnl']

returned = amount + real_pnl
user['balance'] = sanitize_balance(user['balance'] + returned)
user['total_profit'] += real_pnl
```

**–°—Ç—Ä–æ–∫–∏:** 6112-6200

---

### 7. –ó–∞–∫—Ä—ã—Ç–∏–µ "orphan" –ø–æ–∑–∏—Ü–∏–π (—Å—Ç—Ä–æ–∫–∞ 3406-3438)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –±—ã–ª–∏ –æ—Ç–∫—Ä—ã—Ç—ã –Ω–∞ Bybit
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ `amount` –±–µ–∑ PnL
- –ù–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç total_profit (PnL = 0)

**–§–æ—Ä–º—É–ª—ã:**
```python
returned = amount  # –ë–ï–ó PnL
user['balance'] = sanitize_balance(user['balance'] + returned)
# total_profit –ù–ï –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è (pnl = 0)
```

**–°—Ç—Ä–æ–∫–∏:** 3406-3438

---

## üîç –§–æ—Ä–º—É–ª—ã —Ä–∞—Å—á–µ—Ç–∞ P&L

### –ë–∞–∑–æ–≤–∞—è —Ñ–æ—Ä–º—É–ª–∞ PnL:
```python
# –î–ª—è LONG –ø–æ–∑–∏—Ü–∏–∏:
pnl_percent = (exit_price - entry_price) / entry_price
pnl = amount * LEVERAGE * pnl_percent - commission

# –î–ª—è SHORT –ø–æ–∑–∏—Ü–∏–∏:
pnl_percent = (entry_price - exit_price) / entry_price
pnl = amount * LEVERAGE * pnl_percent - commission
```

### –§–æ—Ä–º—É–ª–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å—Ä–µ–¥—Å—Ç–≤:
```python
returned = amount + pnl
```

**–õ–æ–≥–∏–∫–∞:** 
- `amount` - —ç—Ç–æ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω–∞—è —Å—É–º–º–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `pnl` - –ø—Ä–∏–±—ã–ª—å/—É–±—ã—Ç–æ–∫ –æ—Ç —Å–¥–µ–ª–∫–∏
- –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω–∞—è —Å—É–º–º–∞ + —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–¥–µ–ª–∫–∏

---

## üí∞ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –∏ total_profit

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞:
```python
user['balance'] = sanitize_balance(user['balance'] + returned)
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ total_profit:
```python
user['total_profit'] += pnl  # –∏–ª–∏
user['total_profit'] = (user.get('total_profit', 0) or 0) + pnl
```

**–í–∞–∂–Ω–æ:** `total_profit` –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç—Å—è, –∞ –Ω–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∑–∞–Ω–æ–≤–æ (–∫—Ä–æ–º–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ `db_sync_user_profit`).

---

## üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Bybit (hedge_close)

### –§—É–Ω–∫—Ü–∏—è `hedge_close` (–∏–∑ hedger.py, —Å—Ç—Ä–æ–∫–∞ 656)
- –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é –Ω–∞ Bybit —á–µ—Ä–µ–∑ API
- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç `bybit_qty` –¥–ª—è —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –∏–ª–∏ `None` –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `True` –ø—Ä–∏ —É—Å–ø–µ—Ö–µ, `False` –ø—Ä–∏ –æ—à–∏–±–∫–µ

### –ü–æ—Ä—è–¥–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏:
1. **–°–Ω–∞—á–∞–ª–∞** –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –Ω–∞ Bybit —á–µ—Ä–µ–∑ `hedge_close`
2. **–ó–∞—Ç–µ–º** –ø–æ–ª—É—á–∞–µ—Ç—Å—è —Ä–µ–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å Bybit
3. **–ü–æ—Ç–æ–º** —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è PnL —Å —Ä–µ–∞–ª—å–Ω–æ–π —Ü–µ–Ω–æ–π
4. **–í –∫–æ–Ω—Ü–µ** –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –±–∞–ª–∞–Ω—Å –∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ –ë–î

---

## üìä –ü–µ—Ä–µ–Ω–æ—Å –≤ –∏—Å—Ç–æ—Ä–∏—é

### –§—É–Ω–∫—Ü–∏—è `db_close_position`:
```python
# –í—Å—Ç–∞–≤–∫–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é
INSERT INTO history 
    (user_id, symbol, direction, entry, exit_price, sl, tp, amount, commission, pnl, reason, opened_at, closed_at)
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)

# –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö
DELETE FROM positions WHERE id = ?
```

**–í–∞–∂–Ω–æ:** –ü–æ–∑–∏—Ü–∏—è —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ `positions` —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–µ—Ä–µ–Ω–æ—Å–∞ –≤ `history`.

---

## ‚ö†Ô∏è –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–´–ï –ë–ê–ì–ò

### üêõ –ë–ê–ì #1: –î–≤–æ–π–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –≤ `close_symbol_trades`
**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** —Å—Ç—Ä–æ–∫–∞ 3643-3664

**–ü—Ä–æ–±–ª–µ–º–∞:** 
–í —Ñ—É–Ω–∫—Ü–∏–∏ `close_symbol_trades` –±–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è **–≤ —Ü–∏–∫–ª–µ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏**:
```python
for pos in positions_to_close:
    # ...
    user['balance'] = sanitize_balance(user['balance'] + returned)  # –í —Ü–∏–∫–ª–µ!
    user['total_profit'] += pnl  # –í —Ü–∏–∫–ª–µ!
    db_close_position(...)
```

**–†–∏—Å–∫:** –ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –¥–ª—è –æ–¥–Ω–∏—Ö –∏ —Ç–µ—Ö –∂–µ –ø–æ–∑–∏—Ü–∏–π, –±–∞–ª–∞–Ω—Å –º–æ–∂–µ—Ç –æ–±–Ω–æ–≤–∏—Ç—å—Å—è –¥–≤–∞–∂–¥—ã.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–¥—Ö–æ–¥ –∫–∞–∫ –≤ `close_all_trades` - –Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å `total_returned` –∏ `total_pnl`, –∑–∞—Ç–µ–º –æ–±–Ω–æ–≤–ª—è—Ç—å –±–∞–ª–∞–Ω—Å –æ–¥–∏–Ω —Ä–∞–∑ –ø–æ—Å–ª–µ —Ü–∏–∫–ª–∞.

---

### üêõ –ë–ê–ì #2: –ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è total_profit
**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** –†–∞–∑–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –í `close_trade` (—Å—Ç—Ä–æ–∫–∞ 4883): `user['total_profit'] = (user.get('total_profit', 0) or 0) + pnl`
- –í –¥—Ä—É–≥–∏—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö: `user['total_profit'] += pnl`

**–†–∏—Å–∫:** –ï—Å–ª–∏ `total_profit` —Ä–∞–≤–µ–Ω `None` –∏–ª–∏ `0.0`, –ø–æ–≤–µ–¥–µ–Ω–∏–µ –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Ö–æ–¥ - –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `+=` —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞ `None` –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–¥–∏–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.

---

### üêõ –ë–ê–ì #3: –ß–∞—Å—Ç–∏—á–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º—É —Ä–∞—Å—á–µ—Ç—É PnL
**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** TP1, TP2, —á–∞—Å—Ç–∏—á–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ (—Å—Ç—Ä–æ–∫–∏ 5734-6110)

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ü—Ä–∏ —á–∞—Å—Ç–∏—á–Ω–æ–º –∑–∞–∫—Ä—ã—Ç–∏–∏:
1. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è PnL –æ—Ç –∑–∞–∫—Ä—ã–≤–∞–µ–º–æ–π —á–∞—Å—Ç–∏
2. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –±–∞–ª–∞–Ω—Å –∏ total_profit
3. –£–º–µ–Ω—å—à–∞–µ—Ç—Å—è `amount` –ø–æ–∑–∏—Ü–∏–∏
4. –ù–æ `entry` —Ü–µ–Ω–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–µ–π

**–†–∏—Å–∫:** –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º —á–∞—Å—Ç–∏—á–Ω–æ–º –∑–∞–∫—Ä—ã—Ç–∏–∏ PnL —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç –∏—Å—Ö–æ–¥–Ω–æ–≥–æ `entry`, –Ω–æ `amount` —É–∂–µ —É–º–µ–Ω—å—à–µ–Ω. –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º—É —Ä–∞—Å—á–µ—Ç—É, –µ—Å–ª–∏ —Ü–µ–Ω–∞ —Å–∏–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å.

**–ü—Ä–∏–º–µ—Ä:**
- –û—Ç–∫—Ä—ã—Ç–∞ –ø–æ–∑–∏—Ü–∏—è: amount=100, entry=100, current=110
- TP1: –∑–∞–∫—Ä—ã—Ç–æ 50%, pnl –æ—Ç 50 –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ 100‚Üí110
- –ü–æ–∑–∏—Ü–∏—è: amount=50, entry=100, current=120
- TP2: –∑–∞–∫—Ä—ã—Ç–æ 30% –æ—Ç 50, pnl —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç entry=100, –Ω–æ —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—á–∏—Ç–∞—Ç—å –æ—Ç –∏—Å—Ö–æ–¥–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ü—Ä–∏ —á–∞—Å—Ç–∏—á–Ω–æ–º –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å —Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω—É—é —Ü–µ–Ω—É –≤—Ö–æ–¥–∞ (`entry`) –∏–ª–∏ —Ö—Ä–∞–Ω–∏—Ç—å `realized_pnl` –æ—Ç–¥–µ–ª—å–Ω–æ (—á—Ç–æ —É–∂–µ –¥–µ–ª–∞–µ—Ç—Å—è).

---

### üêõ –ë–ê–ì #4: Race condition –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –∑–∞–∫—Ä—ã—Ç–∏–∏
**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞–∫—Ä—ã—Ç–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:**
–í –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ —Ñ—É–Ω–∫—Ü–∏–π –∑–∞–∫—Ä—ã—Ç–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:
```python
user = get_user(user_id)
# ... —Ä–∞—Å—á–µ—Ç—ã ...
user['balance'] = sanitize_balance(user['balance'] + returned)
save_user(user_id)
```

–ù–æ —Ç–æ–ª—å–∫–æ –≤ `close_trade` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞:
```python
async with get_user_lock(user_id):
    user = get_user(user_id)
    user['balance'] = sanitize_balance(user['balance'] + returned)
    save_user(user_id)
```

**–†–∏—Å–∫:** –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–∑–∏—Ü–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ —Ä–∞–∑–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏), –±–∞–ª–∞–Ω—Å –º–æ–∂–µ—Ç –æ–±–Ω–æ–≤–∏—Ç—å—Å—è –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–∑-–∑–∞ race condition.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –≤–æ –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö –∑–∞–∫—Ä—ã—Ç–∏—è.

---

### üêõ –ë–ê–ì #5: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ Bybit PnL
**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** –°—Ç—Ä–æ–∫–∏ 5600-5659, 6125-6159

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ü—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å Bybit –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–∞–ª—å–Ω—ã–π PnL —Å Bybit:
```python
real_pnl = bybit_pnl  # PnL —Å Bybit
returned = amount + real_pnl
```

–ù–æ `bybit_pnl` - —ç—Ç–æ PnL –æ—Ç **–≤—Å–µ–π –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ Bybit**, –∞ –Ω–µ –æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ –≤ –±–æ—Ç–µ. –ï—Å–ª–∏ –Ω–∞ Bybit –æ–¥–Ω–∞ –ø–æ–∑–∏—Ü–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –∑–∞–ø–∏—Å—è–º –≤ –±–æ—Ç–µ, PnL –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ.

**–ü—Ä–∏–º–µ—Ä:**
- –í –±–æ—Ç–µ: 2 –ø–æ–∑–∏—Ü–∏–∏ –ø–æ $50 –∫–∞–∂–¥–∞—è (–≤—Å–µ–≥–æ $100)
- –ù–∞ Bybit: 1 –ø–æ–∑–∏—Ü–∏—è $100
- Bybit PnL: +$20
- –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–µ—Ä–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏: `returned = 50 + 20 = 70` (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!)
- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: `returned = 50 + 10 = 60` (–ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ Bybit PnL —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—å –µ–≥–æ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ `amount` –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏.

---

### üêõ –ë–ê–ì #6: –ö—ç—à –ø–æ–∑–∏—Ü–∏–π –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω
**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞–∫—Ä—ã—Ç–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ü–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ –∫—ç—à –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é:
```python
positions_cache[user_id] = [p for p in positions_cache[user_id] if p.get('id') != pos_id]
```

–ù–æ –µ—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞ –≤ –¥—Ä—É–≥–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ –∏–ª–∏ —á–µ—Ä–µ–∑ –¥—Ä—É–≥—É—é —Ñ—É–Ω–∫—Ü–∏—é, –∫—ç—à –º–æ–∂–µ—Ç –æ—Å—Ç–∞—Ç—å—Å—è —É—Å—Ç–∞—Ä–µ–≤—à–∏–º.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—Ç—å –∫—ç—à –∏–∑ –ë–î –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏.

---

### üêõ –ë–ê–ì #7: –ö–æ–º–∏—Å—Å–∏—è –≤—ã—á–∏—Ç–∞–µ—Ç—Å—è –¥–≤–∞–∂–¥—ã –ø—Ä–∏ —á–∞—Å—Ç–∏—á–Ω–æ–º –∑–∞–∫—Ä—ã—Ç–∏–∏
**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** –ß–∞—Å—Ç–∏—á–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ (TP1, TP2, —á–∞—Å—Ç–∏—á–Ω–æ–µ –Ω–∞ –ø–æ–ª–ø—É—Ç–∏)

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø–æ–∑–∏—Ü–∏–∏ –∫–æ–º–∏—Å—Å–∏—è –≤—ã—á–∏—Ç–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `pos['commission']`.
–ü—Ä–∏ —á–∞—Å—Ç–∏—á–Ω–æ–º –∑–∞–∫—Ä—ã—Ç–∏–∏ –∫–æ–º–∏—Å—Å–∏—è –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ —Ä–∞—Å—á–µ—Ç–µ PnL:
```python
partial_pnl = (current - entry) / entry * close_amount * LEVERAGE
# –ö–æ–º–∏—Å—Å–∏—è –ù–ï –≤—ã—á–∏—Ç–∞–µ—Ç—Å—è!
```

–ù–æ –ø—Ä–∏ –ø–æ–ª–Ω–æ–º –∑–∞–∫—Ä—ã—Ç–∏–∏ –∫–æ–º–∏—Å—Å–∏—è –≤—ã—á–∏—Ç–∞–µ—Ç—Å—è:
```python
pnl = amount * LEVERAGE * pnl_percent - commission
```

**–†–∏—Å–∫:** –ö–æ–º–∏—Å—Å–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å —É—á—Ç–µ–Ω–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–∏ —á–∞—Å—Ç–∏—á–Ω—ã—Ö –∑–∞–∫—Ä—ã—Ç–∏—è—Ö.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ü—Ä–∏ —á–∞—Å—Ç–∏—á–Ω–æ–º –∑–∞–∫—Ä—ã—Ç–∏–∏ –≤—ã—á–∏—Ç–∞—Ç—å –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é —á–∞—Å—Ç—å –∫–æ–º–∏—Å—Å–∏–∏:
```python
partial_commission = commission * (close_amount / original_amount)
partial_pnl = ... - partial_commission
```

---

## ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é

1. **–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞:** –í—Å–µ–≥–¥–∞ –Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å `total_returned` –∏ `total_pnl`, –∑–∞—Ç–µ–º –æ–±–Ω–æ–≤–ª—è—Ç—å –±–∞–ª–∞–Ω—Å –æ–¥–∏–Ω —Ä–∞–∑.

2. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:** –î–æ–±–∞–≤–∏—Ç—å `async with get_user_lock(user_id)` –≤–æ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞–∫—Ä—ã—Ç–∏—è.

3. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—á–µ—Ç —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è:** –£—á–∏—Ç—ã–≤–∞—Ç—å –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –∫–æ–º–∏—Å—Å–∏—é –ø—Ä–∏ —á–∞—Å—Ç–∏—á–Ω–æ–º –∑–∞–∫—Ä—ã—Ç–∏–∏.

4. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ Bybit PnL:** –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ Bybit PnL —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—å –µ–≥–æ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ `amount` –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏.

5. **–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—Ç—å –∫—ç—à:** –ü–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—Ç—å –∫—ç—à –ø–æ–∑–∏—Ü–∏–π –∏–∑ –ë–î –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏.

6. **–î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é:** –ü—Ä–æ–≤–µ—Ä—è—Ç—å, —á—Ç–æ –ø–æ–∑–∏—Ü–∏—è –µ—â–µ –Ω–µ –∑–∞–∫—Ä—ã—Ç–∞ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º.

7. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –ª–æ–≥–æ–≤ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –±–∞–ª–∞–Ω—Å–∞ –∏ total_profit.
