<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Bot Dashboard</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            min-height: 100vh;
            padding: 12px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 20px;
        }
        
        .main-content {
            min-width: 0;
        }
        
        .news-sidebar {
            position: sticky;
            top: 12px;
            height: calc(100vh - 24px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            .news-sidebar {
                position: relative;
                height: auto;
                max-height: 600px;
            }
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #21262d;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        h1 {
            font-size: 1.3rem;
            font-weight: 600;
            color: #f0f6fc;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border: 1px solid #30363d;
            border-radius: 6px;
            background: #21262d;
            color: #c9d1d9;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: #30363d;
            border-color: #8b949e;
        }
        
        .btn-primary {
            background: #238636;
            border-color: #238636;
            color: #fff;
        }
        
        .btn-primary:hover {
            background: #2ea043;
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #238636;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .card {
            background: #161b22;
            border: 1px solid #21262d;
            border-radius: 6px;
            padding: 16px;
        }
        
        .card-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #8b949e;
            margin-bottom: 6px;
        }
        
        .card-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #f0f6fc;
        }
        
        .card-value.positive { color: #238636; }
        .card-value.negative { color: #da3633; }
        .card-value.neutral { color: #58a6ff; }
        .card-value.small { font-size: 1.1rem; }
        
        .card-sub {
            font-size: 0.75rem;
            color: #8b949e;
            margin-top: 4px;
        }
        
        .section {
            margin-bottom: 24px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .section-title {
            font-size: 1rem;
            font-weight: 600;
            color: #f0f6fc;
            padding: 8px 12px;
            background: rgba(33, 38, 45, 0.5);
            border-radius: 6px;
            border-left: 3px solid #58a6ff;
        }
        
        .tabs {
            display: flex;
            gap: 4px;
        }
        
        .tab {
            padding: 6px 12px;
            border: 1px solid #30363d;
            border-radius: 6px;
            background: transparent;
            color: #8b949e;
            font-size: 0.75rem;
            cursor: pointer;
        }
        
        .tab.active {
            background: #21262d;
            color: #f0f6fc;
            border-color: #8b949e;
        }
        
        .reasons-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .reasons-list {
            background: #161b22;
            border: 1px solid #21262d;
            border-radius: 6px;
            padding: 14px;
        }
        
        .reasons-list h3 {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .reasons-list h3.wins { color: #238636; }
        .reasons-list h3.losses { color: #da3633; }
        
        .reason-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #21262d;
            font-size: 0.8rem;
        }
        
        .reason-item:last-child { border-bottom: none; }
        .reason-name { color: #c9d1d9; }
        .reason-count { color: #8b949e; font-weight: 500; }
        
        .trades-table {
            width: 100%;
            border-collapse: collapse;
            background: #161b22;
            border: 1px solid #21262d;
            border-radius: 6px;
            overflow: hidden;
            font-size: 0.8rem;
        }
        
        .trades-table th,
        .trades-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #21262d;
        }
        
        .trades-table th {
            background: #0d1117;
            color: #8b949e;
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.05em;
        }
        
        .trades-table tr:last-child td { border-bottom: none; }
        
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
        }
        
        .badge-long { background: rgba(35, 134, 54, 0.2); color: #238636; }
        .badge-short { background: rgba(218, 54, 51, 0.2); color: #da3633; }
        
        .pnl-positive { color: #238636; }
        .pnl-negative { color: #da3633; }
        
        .no-data {
            color: #8b949e;
            font-style: italic;
            padding: 20px;
            text-align: center;
        }
        
        .updated {
            font-size: 0.75rem;
            color: #8b949e;
        }
        
        /* Logs section */
        .logs-container {
            background: #161b22;
            border: 1px solid #21262d;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-entry {
            padding: 8px 12px;
            border-bottom: 1px solid #21262d;
            font-family: monospace;
            font-size: 0.75rem;
            display: flex;
            gap: 12px;
        }
        
        .log-entry:last-child { border-bottom: none; }
        
        .log-time { color: #8b949e; min-width: 140px; }
        .log-level { min-width: 60px; font-weight: 600; }
        .log-level.INFO { color: #58a6ff; }
        .log-level.WARNING { color: #d29922; }
        .log-level.ERROR { color: #da3633; }
        .log-message { color: #c9d1d9; word-break: break-all; }
        
        /* Share card (hidden, for screenshot) */
        #shareCard {
            position: fixed;
            left: -9999px;
            top: 0;
            width: 500px;
            padding: 24px;
            background: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
            border-radius: 12px;
        }
        
        .share-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid #21262d;
        }
        
        .share-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #f0f6fc;
        }
        
        .share-date {
            font-size: 0.8rem;
            color: #8b949e;
        }
        
        .share-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        .share-stat {
            background: rgba(255,255,255,0.03);
            padding: 14px;
            border-radius: 8px;
            border: 1px solid #21262d;
        }
        
        .share-stat-label {
            font-size: 0.7rem;
            color: #8b949e;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        
        .share-stat-value {
            font-size: 1.4rem;
            font-weight: 700;
        }
        
        .share-footer {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid #21262d;
            font-size: 0.7rem;
            color: #8b949e;
            text-align: center;
        }
        
        /* Streak badge */
        .streak-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .streak-win { background: rgba(35, 134, 54, 0.2); color: #238636; }
        .streak-loss { background: rgba(218, 54, 51, 0.2); color: #da3633; }
        
        /* Main navigation tabs */
        .main-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid #21262d;
            padding-bottom: 12px;
        }
        
        .main-tab {
            padding: 10px 20px;
            border: 1px solid #30363d;
            border-radius: 6px 6px 0 0;
            background: transparent;
            color: #8b949e;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .main-tab:hover {
            background: #21262d;
            color: #c9d1d9;
        }
        
        .main-tab.active {
            background: #238636;
            color: #fff;
            border-color: #238636;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Users table */
        .users-table {
            width: 100%;
            border-collapse: collapse;
            background: #161b22;
            border: 1px solid #21262d;
            border-radius: 6px;
            overflow: hidden;
            font-size: 0.8rem;
        }
        
        .users-table th,
        .users-table td {
            padding: 12px 14px;
            text-align: left;
            border-bottom: 1px solid #21262d;
        }
        
        .users-table th {
            background: #0d1117;
            color: #8b949e;
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.05em;
            position: sticky;
            top: 0;
            cursor: pointer;
        }
        
        .users-table th:hover {
            background: #161b22;
        }
        
        .users-table th.sorted-asc::after { content: ' ‚Üë'; }
        .users-table th.sorted-desc::after { content: ' ‚Üì'; }
        
        .users-table tr:last-child td { border-bottom: none; }
        
        .users-table tr:hover {
            background: #1c2128;
        }
        
        .users-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .summary-card {
            background: #161b22;
            border: 1px solid #21262d;
            border-radius: 6px;
            padding: 14px;
            text-align: center;
        }
        
        .summary-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: #8b949e;
            margin-bottom: 4px;
        }
        
        .summary-value {
            font-size: 1.3rem;
            font-weight: 600;
            color: #f0f6fc;
        }
        
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 500;
        }
        
        .status-on { background: rgba(35, 134, 54, 0.2); color: #238636; }
        .status-off { background: rgba(139, 148, 158, 0.2); color: #8b949e; }
        
        .users-table-container {
            max-height: 600px;
            overflow-y: auto;
            border-radius: 6px;
        }
        
        /* Export dropdown */
        .export-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .export-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            min-width: 180px;
            z-index: 1000;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        }
        
        .export-menu.show {
            display: block;
        }
        
        .export-menu-title {
            padding: 10px 12px;
            font-size: 0.75rem;
            color: #8b949e;
            border-bottom: 1px solid #21262d;
            text-transform: uppercase;
        }
        
        .export-menu-item {
            display: block;
            padding: 10px 12px;
            color: #c9d1d9;
            text-decoration: none;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .export-menu-item:hover {
            background: #21262d;
        }
        
        /* Moscow time badge */
        .tz-badge {
            background: rgba(88, 166, 255, 0.15);
            color: #58a6ff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            margin-left: 4px;
        }
        
        /* Stats highlight cards */
        .card-highlight {
            border-left: 3px solid #238636;
        }
        
        .card-highlight.warning {
            border-left-color: #d29922;
        }
        
        .card-highlight.info {
            border-left-color: #58a6ff;
        }
        
        /* News Feed Styles */
        .news-panel {
            background: #161b22;
            border: 1px solid #21262d;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        
        .news-header {
            padding: 14px 16px;
            border-bottom: 1px solid #21262d;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .news-title {
            font-size: 1rem;
            font-weight: 600;
            color: #f0f6fc;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .news-sentiment {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
        }
        
        .news-sentiment.bullish {
            background: rgba(35, 134, 54, 0.2);
            color: #238636;
        }
        
        .news-sentiment.bearish {
            background: rgba(218, 54, 51, 0.2);
            color: #da3633;
        }
        
        .news-sentiment.neutral {
            background: rgba(88, 166, 255, 0.15);
            color: #58a6ff;
        }
        
        .news-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        
        .news-item {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid #21262d;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .news-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: #30363d;
        }
        
        .news-item:last-child {
            margin-bottom: 0;
        }
        
        .news-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 6px;
        }
        
        .news-source {
            font-size: 0.7rem;
            color: #8b949e;
            font-weight: 500;
        }
        
        .news-source.twitter {
            color: #1DA1F2;
        }
        
        .news-time {
            font-size: 0.65rem;
            color: #6e7681;
            white-space: nowrap;
        }
        
        .news-item-title {
            font-size: 0.8rem;
            color: #c9d1d9;
            line-height: 1.4;
            margin-bottom: 8px;
        }
        
        .news-item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .news-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        
        .news-tag {
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .news-tag.coin {
            background: rgba(88, 166, 255, 0.15);
            color: #58a6ff;
        }
        
        .news-tag.bullish {
            background: rgba(35, 134, 54, 0.2);
            color: #238636;
        }
        
        .news-tag.bearish {
            background: rgba(218, 54, 51, 0.2);
            color: #da3633;
        }
        
        .news-tag.neutral {
            background: rgba(139, 148, 158, 0.2);
            color: #8b949e;
        }
        
        .news-impact {
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .news-impact.critical {
            background: rgba(218, 54, 51, 0.3);
            color: #f85149;
        }
        
        .news-impact.high {
            background: rgba(210, 153, 34, 0.3);
            color: #d29922;
        }
        
        .news-impact.medium {
            background: rgba(88, 166, 255, 0.2);
            color: #58a6ff;
        }
        
        .news-impact.low {
            background: rgba(139, 148, 158, 0.2);
            color: #8b949e;
        }
        
        .news-keywords {
            font-size: 0.65rem;
            color: #6e7681;
            margin-top: 6px;
        }
        
        .news-empty {
            text-align: center;
            padding: 40px 20px;
            color: #8b949e;
        }
        
        .news-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 20px;
            color: #8b949e;
            font-size: 0.85rem;
        }
        
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #30363d;
            border-top-color: #58a6ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            body { padding: 8px; }
            .reasons-grid { grid-template-columns: 1fr; }
            .grid { grid-template-columns: repeat(2, 1fr); }
            .header-actions { width: 100%; justify-content: space-between; }
            .main-tabs { flex-wrap: wrap; gap: 4px; }
            .main-tab { padding: 8px 12px; font-size: 0.8rem; }
            .users-table { font-size: 0.65rem; }
            .users-table th, .users-table td { padding: 6px 4px; }
            .card { padding: 12px; }
            .card-value { font-size: 1.2rem; }
            .card-label { font-size: 0.6rem; }
            h1 { font-size: 1.1rem; }
            .btn { padding: 6px 10px; font-size: 0.75rem; }
            .section-title { font-size: 0.9rem; }
            .trades-table { font-size: 0.7rem; }
            .trades-table th, .trades-table td { padding: 8px 6px; }
            .log-entry { flex-wrap: wrap; gap: 4px; }
            .log-time { min-width: 100px; font-size: 0.65rem; }
            .log-message { font-size: 0.7rem; }
        }
        
        @media (max-width: 480px) {
            .grid { grid-template-columns: 1fr 1fr; gap: 8px; }
            .card { padding: 10px; }
            .card-value { font-size: 1rem; }
            .header-actions { gap: 4px; }
            .btn { padding: 5px 8px; font-size: 0.7rem; gap: 3px; }
            .main-tabs { padding-bottom: 8px; margin-bottom: 16px; }
            .main-tab { padding: 6px 10px; font-size: 0.75rem; flex: 1; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Trading Bot <span class="tz-badge">MSK</span></h1>
            <div class="header-actions">
                <div class="status">
                    <span class="status-dot"></span>
                    <span>Live</span>
                    <span class="updated" id="lastUpdate">-</span>
                </div>
                <button class="btn" onclick="refreshAll()">
                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                        <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966a.25.25 0 0 1 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                    </svg>
                    Refresh
                </button>
                <div class="export-dropdown">
                    <button class="btn" onclick="toggleExportMenu()">
                        <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                        </svg>
                        Export
                    </button>
                    <div class="export-menu" id="exportMenu">
                        <div class="export-menu-title">–ü–µ—Ä–∏–æ–¥ —ç–∫—Å–ø–æ—Ä—Ç–∞</div>
                        <div class="export-menu-item" onclick="exportLogs(1, 'hours')">1 —á–∞—Å</div>
                        <div class="export-menu-item" onclick="exportLogs(6, 'hours')">6 —á–∞—Å–æ–≤</div>
                        <div class="export-menu-item" onclick="exportLogs(12, 'hours')">12 —á–∞—Å–æ–≤</div>
                        <div class="export-menu-item" onclick="exportLogs(24, 'hours')">24 —á–∞—Å–∞</div>
                        <div class="export-menu-item" onclick="exportLogs(3, 'days')">3 –¥–Ω—è</div>
                        <div class="export-menu-item" onclick="exportLogs(7, 'days')">7 –¥–Ω–µ–π</div>
                        <div class="export-menu-item" onclick="exportLogs(30, 'days')">30 –¥–Ω–µ–π</div>
                        <div class="export-menu-item" onclick="exportLogs(1, 'months')">1 –º–µ—Å—è—Ü</div>
                        <div class="export-menu-item" onclick="exportLogs(3, 'months')">3 –º–µ—Å—è—Ü–∞</div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="shareStats()">
                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M13.5 1a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.499 2.499 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5zm-8.5 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zm11 5.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3z"/>
                    </svg>
                    Share
                </button>
            </div>
        </header>
        
        <!-- Main Navigation Tabs -->
        <div class="main-tabs">
            <button class="main-tab active" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="main-tab" onclick="switchTab('users')">üë• Users</button>
        </div>
        
        <div class="main-layout">
        <div class="main-content">
        
        <!-- Dashboard Tab -->
        <div id="tab-dashboard" class="tab-content active">
        
        <!-- üìä –°–ï–ö–¶–ò–Ø: –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
        <div class="section">
            <h2 class="section-title">üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ</h2>
            <div class="grid">
                <div class="card card-highlight info">
                    <div class="card-label">üîì –û—Ç–∫—Ä—ã—Ç—ã–µ —Å–¥–µ–ª–∫–∏</div>
                    <div class="card-value neutral" id="openDeals">-</div>
                </div>
                <div class="card">
                    <div class="card-label">üí∞ –û–±—â–∏–π PnL</div>
                    <div class="card-value" id="totalPnl">-</div>
                </div>
                <div class="card">
                    <div class="card-label">üìà –°–µ–≥–æ–¥–Ω—è PnL</div>
                    <div class="card-value" id="todayPnl">-</div>
                    <div class="card-sub" id="todayTrades">-</div>
                </div>
                <div class="card">
                    <div class="card-label">üî• –°–µ—Ä–∏—è</div>
                    <div class="card-value" id="streak">-</div>
                </div>
            </div>
        </div>
        
        <!-- ü§ñ –°–ï–ö–¶–ò–Ø: –ê–Ω–∞–ª–∏–∑ —Å–∏–≥–Ω–∞–ª–æ–≤ -->
        <div class="section">
            <h2 class="section-title">ü§ñ –ê–Ω–∞–ª–∏–∑ —Å–∏–≥–Ω–∞–ª–æ–≤</h2>
            <div class="grid">
                <div class="card card-highlight info">
                    <div class="card-label">üîç –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ</div>
                    <div class="card-value neutral" id="analyzed">-</div>
                </div>
                <div class="card card-highlight">
                    <div class="card-label">‚úÖ –ü—Ä–æ—à–ª–æ —Ñ–∏–ª—å—Ç—Ä—ã</div>
                    <div class="card-value positive" id="validSetups">-</div>
                    <div class="card-sub" id="validSetupsPct">-</div>
                </div>
                <div class="card card-highlight warning">
                    <div class="card-label">‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ</div>
                    <div class="card-value" id="rejected">-</div>
                    <div class="card-sub" id="rejectedPct">-</div>
                </div>
                <div class="card">
                    <div class="card-label">üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —é–∑–µ—Ä–∞–º</div>
                    <div class="card-value small neutral" id="accepted">-</div>
                </div>
                <div class="card">
                    <div class="card-label">üì° –ù–∞ Bybit</div>
                    <div class="card-value small neutral" id="bybitOpened">-</div>
                </div>
            </div>
        </div>
        
        <!-- üìà –°–ï–ö–¶–ò–Ø: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–æ—Ä–≥–æ–≤–ª–∏ -->
        <div class="section">
            <h2 class="section-title">üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–æ—Ä–≥–æ–≤–ª–∏</h2>
            <div class="grid">
                <div class="card">
                    <div class="card-label">üèÜ Win Rate</div>
                    <div class="card-value" id="winRate">-</div>
                </div>
                <div class="card">
                    <div class="card-label">‚úÖ –ü—Ä–æ—Ñ–∏—Ç–Ω—ã–µ</div>
                    <div class="card-value positive" id="profitable">-</div>
                </div>
                <div class="card">
                    <div class="card-label">‚ùå –£–±—ã—Ç–æ—á–Ω—ã–µ</div>
                    <div class="card-value negative" id="losing">-</div>
                </div>
                <div class="card">
                    <div class="card-label">üìä –í—Å–µ–≥–æ –∑–∞–∫—Ä—ã—Ç–æ</div>
                    <div class="card-value" id="totalClosed">-</div>
                </div>
                <div class="card">
                    <div class="card-label">üíµ Avg Win/Loss</div>
                    <div class="card-value small">
                        <span class="positive" id="avgWin">-</span> / 
                        <span class="negative" id="avgLoss">-</span>
                    </div>
                </div>
                <div class="card">
                    <div class="card-label">üíé –û–±—ä—ë–º</div>
                    <div class="card-value small" id="totalVolume">-</div>
                </div>
            </div>
        </div>
        
        <!-- üèÖ –°–ï–ö–¶–ò–Ø: –õ—É—á—à–∏–µ/–•—É–¥—à–∏–µ -->
        <div class="section">
            <h2 class="section-title">üèÖ –†–µ–∫–æ—Ä–¥—ã</h2>
            <div class="grid" style="grid-template-columns: repeat(2, 1fr);">
                <div class="card">
                    <div class="card-label">üöÄ –õ—É—á—à–∞—è —Å–¥–µ–ª–∫–∞</div>
                    <div class="card-value small positive" id="bestTrade">-</div>
                    <div class="card-sub" id="bestTradeInfo">-</div>
                </div>
                <div class="card">
                    <div class="card-label">üíÄ –•—É–¥—à–∞—è —Å–¥–µ–ª–∫–∞</div>
                    <div class="card-value small negative" id="worstTrade">-</div>
                    <div class="card-sub" id="worstTradeInfo">-</div>
                </div>
            </div>
        </div>
        
        <!-- üéØ –°–ï–ö–¶–ò–Ø: –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –ø–æ –ø–æ—Ä–æ–≥–∞–º -->
        <div class="section">
            <h2 class="section-title">üéØ –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –ø–æ –ø–æ—Ä–æ–≥–∞–º</h2>
            <div class="grid" style="grid-template-columns: repeat(5, 1fr);">
                <div class="card">
                    <div class="card-label">>60% WR</div>
                    <div class="card-value small" id="wr60">-</div>
                    <div class="card-sub" id="wr60trades">-</div>
                </div>
                <div class="card">
                    <div class="card-label">>70% WR</div>
                    <div class="card-value small" id="wr70">-</div>
                    <div class="card-sub" id="wr70trades">-</div>
                </div>
                <div class="card">
                    <div class="card-label">>80% WR</div>
                    <div class="card-value small positive" id="wr80">-</div>
                    <div class="card-sub" id="wr80trades">-</div>
                </div>
                <div class="card">
                    <div class="card-label">>90% WR</div>
                    <div class="card-value small positive" id="wr90">-</div>
                    <div class="card-sub" id="wr90trades">-</div>
                </div>
                <div class="card">
                    <div class="card-label">>95% WR</div>
                    <div class="card-value small positive" id="wr95">-</div>
                    <div class="card-sub" id="wr95trades">-</div>
                </div>
            </div>
        </div>
        
        <!-- Reasons Section -->
        <div class="section">
            <h2 class="section-title">Reasons Analysis</h2>
            <div class="reasons-grid">
                <div class="reasons-list">
                    <h3 class="wins">Winning Reasons</h3>
                    <div id="winReasons"><div class="no-data">No data</div></div>
                </div>
                <div class="reasons-list">
                    <h3 class="losses">Losing Reasons</h3>
                    <div id="lossReasons"><div class="no-data">No data</div></div>
                </div>
            </div>
        </div>
        
        <!-- Recent Trades Section -->
        <div class="section">
            <h2 class="section-title">Recent Trades</h2>
            <table class="trades-table">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Direction</th>
                        <th>PnL</th>
                        <th>Reason</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody id="tradesBody">
                    <tr><td colspan="5" class="no-data">Loading...</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- Logs Section -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Bot Logs</h2>
                <div class="tabs">
                    <button class="tab active" onclick="filterLogs('all')">All</button>
                    <button class="tab" onclick="filterLogs('INFO')">Info</button>
                    <button class="tab" onclick="filterLogs('WARNING')">Warning</button>
                    <button class="tab" onclick="filterLogs('ERROR')">Error</button>
                </div>
            </div>
            <div class="logs-container" id="logsContainer">
                <div class="no-data">Loading logs...</div>
            </div>
        </div>
        
        <!-- User Diagnostics Section -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">User Diagnostics</h2>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="userIdInput" placeholder="Enter User ID" 
                        style="padding: 8px 12px; background: #161b22; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; font-size: 0.875rem;">
                    <button class="btn" onclick="lookupUser()">Lookup</button>
                </div>
            </div>
            <div id="userInfoContainer" style="display: none;">
                <div class="grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="card">
                        <div class="card-label">Balance</div>
                        <div class="card-value small" id="userBalance">-</div>
                    </div>
                    <div class="card">
                        <div class="card-label">Total Deposit</div>
                        <div class="card-value small" id="userDeposit">-</div>
                    </div>
                    <div class="card">
                        <div class="card-label">Total Profit</div>
                        <div class="card-value small" id="userProfit">-</div>
                    </div>
                    <div class="card">
                        <div class="card-label">Missing $</div>
                        <div class="card-value small negative" id="userMissing">-</div>
                    </div>
                </div>
                <div style="margin-top: 12px;">
                    <h3 style="font-size: 0.875rem; margin-bottom: 8px; color: #8b949e;">Open Positions (<span id="userPosCount">0</span>)</h3>
                    <div class="logs-container" id="userPositions" style="max-height: 150px;">
                        <div class="no-data">No positions</div>
                    </div>
                </div>
                <div style="margin-top: 12px;">
                    <h3 style="font-size: 0.875rem; margin-bottom: 8px; color: #8b949e;">Trade History (<span id="userHistCount">0</span>)</h3>
                    <div class="logs-container" id="userHistory" style="max-height: 200px;">
                        <div class="no-data">No history</div>
                    </div>
                </div>
                <div style="margin-top: 12px;">
                    <h3 style="font-size: 0.875rem; margin-bottom: 8px; color: #8b949e;">User Activity Logs</h3>
                    <div class="logs-container" id="userLogs" style="max-height: 200px;">
                        <div class="no-data">No logs</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Users Tab -->
    <div id="tab-users" class="tab-content">
        <div class="users-summary">
            <div class="summary-card">
                <div class="summary-label">–í—Å–µ–≥–æ —é–∑–µ—Ä–æ–≤</div>
                <div class="summary-value" id="totalUsers">-</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</div>
                <div class="summary-value" id="usersBalance">-</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">–î–µ–ø–æ–∑–∏—Ç—ã</div>
                <div class="summary-value" id="usersDeposits">-</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
                <div class="summary-value" id="activeTraders">-</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">–ê–≤—Ç–æ-—Ç—Ä–µ–π–¥</div>
                <div class="summary-value" id="autoTraders">-</div>
            </div>
        </div>
        
        <div class="users-table-container">
            <table class="users-table">
                <thead>
                    <tr>
                        <th onclick="sortUsers('user_id')">ID</th>
                        <th onclick="sortUsers('balance')">–ë–∞–ª–∞–Ω—Å</th>
                        <th onclick="sortUsers('total_deposit')">–î–µ–ø–æ–∑–∏—Ç</th>
                        <th onclick="sortUsers('total_trades')">–°–¥–µ–ª–æ–∫</th>
                        <th onclick="sortUsers('wins')">W/L</th>
                        <th onclick="sortUsers('winrate')">WR%</th>
                        <th onclick="sortUsers('total_pnl')">PnL</th>
                        <th onclick="sortUsers('open_positions')">–ü–æ–∑–∏—Ü–∏–∏</th>
                        <th onclick="sortUsers('trading')">–¢–æ—Ä–≥—É–µ—Ç</th>
                        <th onclick="sortUsers('auto_trade')">–ê–≤—Ç–æ</th>
                    </tr>
                </thead>
                <tbody id="usersBody">
                    <tr><td colspan="10" class="no-data">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    </div><!-- /.main-content -->
    
    <!-- News Sidebar -->
    <div class="news-sidebar">
        <div class="news-panel">
            <div class="news-header">
                <span class="news-title">üì∞ News & üê¶ Twitter</span>
                <span class="news-sentiment neutral" id="newsSentiment">
                    <span id="sentimentIcon">‚öñÔ∏è</span>
                    <span id="sentimentText">NEUTRAL</span>
                    <span id="sentimentScore">(0)</span>
                </span>
            </div>
            <div class="news-list" id="newsList">
                <div class="news-loading">
                    <div class="spinner"></div>
                    <span>–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π...</span>
                </div>
            </div>
        </div>
    </div>
    
    </div><!-- /.main-layout -->
    
    <!-- Hidden Share Card -->
    <div id="shareCard">
        <div class="share-header">
            <span class="share-title">Trading Bot Stats</span>
            <span class="share-date" id="shareDate">-</span>
        </div>
        <div class="share-grid">
            <div class="share-stat">
                <div class="share-stat-label">Win Rate</div>
                <div class="share-stat-value" id="shareWinRate" style="color: #238636">-</div>
            </div>
            <div class="share-stat">
                <div class="share-stat-label">Total PnL</div>
                <div class="share-stat-value" id="sharePnl">-</div>
            </div>
            <div class="share-stat">
                <div class="share-stat-label">Profitable</div>
                <div class="share-stat-value" style="color: #238636" id="shareProfitable">-</div>
            </div>
            <div class="share-stat">
                <div class="share-stat-label">Losing</div>
                <div class="share-stat-value" style="color: #da3633" id="shareLosing">-</div>
            </div>
            <div class="share-stat">
                <div class="share-stat-label">Today's PnL</div>
                <div class="share-stat-value" id="shareTodayPnl">-</div>
            </div>
            <div class="share-stat">
                <div class="share-stat-label">Open Deals</div>
                <div class="share-stat-value" style="color: #58a6ff" id="shareOpen">-</div>
            </div>
        </div>
        <div class="share-footer">Generated by Trading Bot Dashboard</div>
    </div>
    
    <script>
        let currentStats = {};
        let currentExtended = {};
        let allLogs = [];
        let currentLogFilter = 'all';
        let allUsers = [];
        let usersSortField = 'balance';
        let usersSortDir = 'desc';
        
        function formatPnl(value) {
            const num = parseFloat(value) || 0;
            const sign = num >= 0 ? '+' : '';
            return sign + '$' + num.toFixed(2);
        }
        
        // Convert to Moscow time (UTC+3)
        function toMoscowTime(date) {
            // Moscow is UTC+3
            const moscowOffset = 3 * 60; // minutes
            const utc = date.getTime() + (date.getTimezoneOffset() * 60000);
            return new Date(utc + (moscowOffset * 60000));
        }
        
        function formatTime(isoString) {
            if (!isoString) return '-';
            const date = toMoscowTime(new Date(isoString));
            return date.toLocaleString('ru-RU', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit',
                day: '2-digit',
                month: '2-digit',
                hour12: false 
            });
        }
        
        function formatTime24(date) {
            const moscow = toMoscowTime(date);
            return moscow.toLocaleString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour12: false
            }) + ' MSK';
        }
        
        // Export dropdown functions
        function toggleExportMenu() {
            const menu = document.getElementById('exportMenu');
            menu.classList.toggle('show');
        }
        
        function exportLogs(value, unit) {
            let url = '/api/export_logs?';
            if (unit === 'hours') url += `hours=${value}`;
            else if (unit === 'days') url += `days=${value}`;
            else if (unit === 'months') url += `months=${value}`;
            
            window.location.href = url;
            document.getElementById('exportMenu').classList.remove('show');
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.querySelector('.export-dropdown');
            if (dropdown && !dropdown.contains(e.target)) {
                document.getElementById('exportMenu').classList.remove('show');
            }
        });
        
        function renderReasons(reasons, containerId) {
            const container = document.getElementById(containerId);
            if (!reasons || Object.keys(reasons).length === 0) {
                container.innerHTML = '<div class="no-data">No data</div>';
                return;
            }
            
            let html = '';
            for (const [reason, count] of Object.entries(reasons)) {
                html += `
                    <div class="reason-item">
                        <span class="reason-name">${reason || 'Unknown'}</span>
                        <span class="reason-count">${count}</span>
                    </div>
                `;
            }
            container.innerHTML = html;
        }
        
        function renderTrades(trades) {
            const tbody = document.getElementById('tradesBody');
            if (!trades || trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="no-data">No trades yet</td></tr>';
                return;
            }
            
            let html = '';
            for (const trade of trades.slice(0, 15)) {
                const pnl = parseFloat(trade.pnl || 0);
                const pnlClass = pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
                const dirClass = trade.direction === 'LONG' ? 'badge-long' : 'badge-short';
                const symbol = trade.symbol ? trade.symbol.split('/')[0] : '-';
                
                html += `
                    <tr>
                        <td>${symbol}</td>
                        <td><span class="badge ${dirClass}">${trade.direction || '-'}</span></td>
                        <td class="${pnlClass}">${formatPnl(pnl)}</td>
                        <td>${trade.reason || '-'}</td>
                        <td>${formatTime(trade.closed_at)}</td>
                    </tr>
                `;
            }
            tbody.innerHTML = html;
        }
        
        function renderLogs(logs) {
            const container = document.getElementById('logsContainer');
            
            let filteredLogs = logs;
            if (currentLogFilter !== 'all') {
                filteredLogs = logs.filter(l => l.level === currentLogFilter);
            }
            
            if (!filteredLogs || filteredLogs.length === 0) {
                container.innerHTML = '<div class="no-data">No logs</div>';
                return;
            }
            
            let html = '';
            for (const log of filteredLogs.slice(0, 100)) {
                html += `
                    <div class="log-entry">
                        <span class="log-time">${log.timestamp || '-'}</span>
                        <span class="log-level ${log.level}">${log.level}</span>
                        <span class="log-message">${log.message || '-'}</span>
                    </div>
                `;
            }
            container.innerHTML = html;
        }
        
        function filterLogs(level) {
            currentLogFilter = level;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            renderLogs(allLogs);
        }
        
        async function fetchStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                currentStats = data;
                
                // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π —Å fallback –Ω–∞ 0
                const openDeals = data.open_deals ?? 0;
                const profitable = data.profitable ?? 0;
                const losing = data.losing ?? 0;
                const totalClosed = data.total_closed ?? 0;
                const winRate = data.win_rate ?? 0;
                
                document.getElementById('openDeals').textContent = openDeals;
                document.getElementById('winRate').textContent = winRate + '%';
                document.getElementById('profitable').textContent = profitable;
                document.getElementById('losing').textContent = losing;
                document.getElementById('totalClosed').textContent = totalClosed;
                
                // Signal analysis stats
                const analyzed = data.analyzed ?? 0;
                const accepted = data.accepted ?? 0;
                const rejected = data.rejected ?? 0;
                const validSetups = data.valid_setups ?? 0;
                const bybitOpened = data.bybit_opened ?? 0;
                
                document.getElementById('analyzed').textContent = analyzed.toLocaleString();
                document.getElementById('validSetups').textContent = validSetups.toLocaleString();
                document.getElementById('accepted').textContent = accepted.toLocaleString();
                document.getElementById('rejected').textContent = rejected.toLocaleString();
                document.getElementById('bybitOpened').textContent = bybitOpened.toLocaleString();
                
                const validPct = analyzed > 0 ? ((validSetups / analyzed) * 100).toFixed(1) : 0;
                const rejectedPct = analyzed > 0 ? ((rejected / analyzed) * 100).toFixed(1) : 0;
                document.getElementById('validSetupsPct').textContent = `${validPct}% –∫–æ–Ω–≤–µ—Ä—Å–∏—è`;
                document.getElementById('rejectedPct').textContent = `${rejectedPct}% –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ`;
                
                const pnl = parseFloat(data.total_pnl || 0);
                const pnlEl = document.getElementById('totalPnl');
                pnlEl.textContent = formatPnl(pnl);
                pnlEl.className = 'card-value ' + (pnl >= 0 ? 'positive' : 'negative');
                
                const winRateEl = document.getElementById('winRate');
                winRateEl.className = 'card-value ' + (winRate >= 50 ? 'positive' : winRate > 0 ? 'negative' : '');
                
                renderReasons(data.win_reasons || {}, 'winReasons');
                renderReasons(data.loss_reasons || {}, 'lossReasons');
                
                document.getElementById('lastUpdate').textContent = formatTime24(new Date());
                
                // Debug log
                console.log('[Dashboard] Stats loaded:', {openDeals, profitable, losing, totalClosed, winRate, analyzed, rejected});
                    
            } catch (error) {
                console.error('Error fetching stats:', error);
            }
        }
        
        async function fetchWinrateBreakdown() {
            try {
                const response = await fetch('/api/winrate_breakdown');
                const data = await response.json();
                
                console.log('[Dashboard] Winrate breakdown:', data);
                
                if (data.thresholds) {
                    const t = data.thresholds;
                    
                    const wr60 = t['60'] || {users: 0, trades: 0};
                    const wr70 = t['70'] || {users: 0, trades: 0};
                    const wr80 = t['80'] || {users: 0, trades: 0};
                    const wr90 = t['90'] || {users: 0, trades: 0};
                    const wr95 = t['95'] || {users: 0, trades: 0};
                    
                    document.getElementById('wr60').textContent = (wr60.users || 0) + ' —é–∑–µ—Ä–æ–≤';
                    document.getElementById('wr60trades').textContent = (wr60.trades || 0) + ' —Å–¥–µ–ª–æ–∫';
                    
                    document.getElementById('wr70').textContent = (wr70.users || 0) + ' —é–∑–µ—Ä–æ–≤';
                    document.getElementById('wr70trades').textContent = (wr70.trades || 0) + ' —Å–¥–µ–ª–æ–∫';
                    
                    document.getElementById('wr80').textContent = (wr80.users || 0) + ' —é–∑–µ—Ä–æ–≤';
                    document.getElementById('wr80trades').textContent = (wr80.trades || 0) + ' —Å–¥–µ–ª–æ–∫';
                    
                    document.getElementById('wr90').textContent = (wr90.users || 0) + ' —é–∑–µ—Ä–æ–≤';
                    document.getElementById('wr90trades').textContent = (wr90.trades || 0) + ' —Å–¥–µ–ª–æ–∫';
                    
                    document.getElementById('wr95').textContent = (wr95.users || 0) + ' —é–∑–µ—Ä–æ–≤';
                    document.getElementById('wr95trades').textContent = (wr95.trades || 0) + ' —Å–¥–µ–ª–æ–∫';
                } else if (data.error) {
                    console.error('[Dashboard] Winrate breakdown error:', data.error);
                }
            } catch (error) {
                console.error('Error fetching winrate breakdown:', error);
            }
        }
        
        async function fetchExtended() {
            try {
                const response = await fetch('/api/extended');
                const data = await response.json();
                currentExtended = data;
                
                // Today
                const todayPnl = parseFloat(data.today_pnl || 0);
                const todayEl = document.getElementById('todayPnl');
                todayEl.textContent = formatPnl(todayPnl);
                todayEl.className = 'card-value ' + (todayPnl >= 0 ? 'positive' : 'negative');
                document.getElementById('todayTrades').textContent = 
                    `${data.today_wins || 0}/${data.today_trades || 0} wins today`;
                
                // Avg
                document.getElementById('avgWin').textContent = '+$' + (data.avg_win || 0).toFixed(2);
                document.getElementById('avgLoss').textContent = '$' + (data.avg_loss || 0).toFixed(2);
                
                // Best/Worst
                if (data.best_trade) {
                    document.getElementById('bestTrade').textContent = formatPnl(data.best_trade.pnl);
                    document.getElementById('bestTradeInfo').textContent = 
                        `${data.best_trade.symbol?.split('/')[0] || '-'} ${data.best_trade.direction || ''}`;
                }
                if (data.worst_trade) {
                    document.getElementById('worstTrade').textContent = formatPnl(data.worst_trade.pnl);
                    document.getElementById('worstTradeInfo').textContent = 
                        `${data.worst_trade.symbol?.split('/')[0] || '-'} ${data.worst_trade.direction || ''}`;
                }
                
                // Streak
                const streakEl = document.getElementById('streak');
                if (data.current_streak && data.streak_type) {
                    const streakClass = data.streak_type === 'win' ? 'streak-win' : 'streak-loss';
                    const streakIcon = data.streak_type === 'win' ? 'üî•' : '‚ùÑÔ∏è';
                    streakEl.innerHTML = `<span class="streak-badge ${streakClass}">${streakIcon} ${data.current_streak} ${data.streak_type}s</span>`;
                } else {
                    streakEl.textContent = '-';
                }
                
                // Volume
                document.getElementById('totalVolume').textContent = '$' + (data.total_volume || 0).toLocaleString();
                
            } catch (error) {
                console.error('Error fetching extended:', error);
            }
        }
        
        async function fetchTrades() {
            try {
                const response = await fetch('/api/trades');
                const data = await response.json();
                renderTrades(data.trades);
            } catch (error) {
                console.error('Error fetching trades:', error);
            }
        }
        
        async function fetchLogs() {
            try {
                const response = await fetch('/api/logs?limit=100');
                const data = await response.json();
                allLogs = data.memory_logs || [];
                renderLogs(allLogs);
            } catch (error) {
                console.error('Error fetching logs:', error);
            }
        }
        
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
            
            // Show selected tab
            document.getElementById('tab-' + tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Load data for users tab if needed
            if (tabName === 'users' && allUsers.length === 0) {
                fetchUsers();
            }
        }
        
        async function fetchUsers() {
            try {
                const response = await fetch('/api/users');
                const data = await response.json();
                allUsers = data.users || [];
                
                // Update summary
                document.getElementById('totalUsers').textContent = data.count || 0;
                document.getElementById('usersBalance').textContent = '$' + (data.totals?.total_balance || 0).toLocaleString();
                document.getElementById('usersDeposits').textContent = '$' + (data.totals?.total_deposits || 0).toLocaleString();
                document.getElementById('activeTraders').textContent = data.totals?.active_traders || 0;
                document.getElementById('autoTraders').textContent = data.totals?.auto_traders || 0;
                
                renderUsers();
            } catch (error) {
                console.error('Error fetching users:', error);
            }
        }
        
        function sortUsers(field) {
            // Update sort headers
            document.querySelectorAll('.users-table th').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });
            
            if (usersSortField === field) {
                usersSortDir = usersSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                usersSortField = field;
                usersSortDir = 'desc';
            }
            
            // Add class to current header
            const headers = document.querySelectorAll('.users-table th');
            const fieldIndex = ['user_id', 'balance', 'total_deposit', 'total_trades', 'wins', 'winrate', 'total_pnl', 'open_positions', 'trading', 'auto_trade'].indexOf(field);
            if (fieldIndex >= 0 && headers[fieldIndex]) {
                headers[fieldIndex].classList.add('sorted-' + usersSortDir);
            }
            
            renderUsers();
        }
        
        function renderUsers() {
            const tbody = document.getElementById('usersBody');
            
            if (!allUsers || allUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="no-data">No users found</td></tr>';
                return;
            }
            
            // Sort users
            const sorted = [...allUsers].sort((a, b) => {
                let aVal = a[usersSortField];
                let bVal = b[usersSortField];
                
                // Handle booleans
                if (typeof aVal === 'boolean') aVal = aVal ? 1 : 0;
                if (typeof bVal === 'boolean') bVal = bVal ? 1 : 0;
                
                if (usersSortDir === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            let html = '';
            for (const user of sorted) {
                const pnlClass = user.total_pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
                const tradingBadge = user.trading 
                    ? '<span class="status-badge status-on">ON</span>' 
                    : '<span class="status-badge status-off">OFF</span>';
                const autoBadge = user.auto_trade 
                    ? '<span class="status-badge status-on">ON</span>' 
                    : '<span class="status-badge status-off">OFF</span>';
                
                html += `
                    <tr>
                        <td><code>${user.user_id}</code></td>
                        <td>$${user.balance.toLocaleString()}</td>
                        <td>$${user.total_deposit.toLocaleString()}</td>
                        <td>${user.total_trades}</td>
                        <td>${user.wins}/${user.total_trades}</td>
                        <td>${user.winrate}%</td>
                        <td class="${pnlClass}">${formatPnl(user.total_pnl)}</td>
                        <td>${user.open_positions}</td>
                        <td>${tradingBadge}</td>
                        <td>${autoBadge}</td>
                    </tr>
                `;
            }
            tbody.innerHTML = html;
        }
        
        function refreshAll() {
            fetchStats();
            fetchExtended();
            fetchTrades();
            fetchLogs();
            fetchWinrateBreakdown();
        }
        
        async function shareStats() {
            // Update share card data
            document.getElementById('shareDate').textContent = formatTime24(new Date());
            document.getElementById('shareWinRate').textContent = (currentStats.win_rate || 0) + '%';
            
            const pnl = parseFloat(currentStats.total_pnl || 0);
            const sharePnlEl = document.getElementById('sharePnl');
            sharePnlEl.textContent = formatPnl(pnl);
            sharePnlEl.style.color = pnl >= 0 ? '#238636' : '#da3633';
            
            document.getElementById('shareProfitable').textContent = currentStats.profitable || 0;
            document.getElementById('shareLosing').textContent = currentStats.losing || 0;
            
            const todayPnl = parseFloat(currentExtended.today_pnl || 0);
            const shareTodayEl = document.getElementById('shareTodayPnl');
            shareTodayEl.textContent = formatPnl(todayPnl);
            shareTodayEl.style.color = todayPnl >= 0 ? '#238636' : '#da3633';
            
            document.getElementById('shareOpen').textContent = currentStats.open_deals || 0;
            
            // Move card temporarily to visible area
            const shareCard = document.getElementById('shareCard');
            shareCard.style.left = '0';
            shareCard.style.top = '0';
            shareCard.style.position = 'absolute';
            shareCard.style.zIndex = '-1';
            
            try {
                const canvas = await html2canvas(shareCard, {
                    backgroundColor: '#0d1117',
                    scale: 2
                });
                
                // Convert to blob and copy/download
                canvas.toBlob(async (blob) => {
                    try {
                        // Try to copy to clipboard
                        await navigator.clipboard.write([
                            new ClipboardItem({ 'image/png': blob })
                        ]);
                        alert('Screenshot copied to clipboard!');
                    } catch (e) {
                        // Fallback: download
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'trading-stats-' + new Date().toISOString().slice(0,10) + '.png';
                        a.click();
                        URL.revokeObjectURL(url);
                    }
                }, 'image/png');
            } catch (error) {
                console.error('Error creating screenshot:', error);
                alert('Error creating screenshot');
            }
            
            // Hide card again
            shareCard.style.left = '-9999px';
        }
        
        async function lookupUser() {
            const userId = document.getElementById('userIdInput').value.trim().replace(/\s/g, '');
            if (!userId) {
                alert('Enter a User ID');
                return;
            }
            
            try {
                const response = await fetch(`/api/user/${userId}`);
                const data = await response.json();
                
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                document.getElementById('userInfoContainer').style.display = 'block';
                
                // Balance info
                const balance = parseFloat(data.balance || 0);
                const deposit = parseFloat(data.total_deposit || 0);
                const profit = parseFloat(data.total_profit || 0);
                
                document.getElementById('userBalance').textContent = '$' + balance.toFixed(2);
                document.getElementById('userDeposit').textContent = '$' + deposit.toFixed(2);
                
                const profitEl = document.getElementById('userProfit');
                profitEl.textContent = formatPnl(profit);
                profitEl.className = 'card-value small ' + (profit >= 0 ? 'positive' : 'negative');
                
                // Calculate missing money
                // Expected: deposit + profit = balance + open positions amount
                const openPosAmount = (data.open_positions || []).reduce((sum, p) => sum + (p.amount || 0), 0);
                const expected = deposit + profit;
                const actual = balance + openPosAmount;
                const missing = expected - actual;
                
                const missingEl = document.getElementById('userMissing');
                missingEl.textContent = '$' + missing.toFixed(2);
                missingEl.className = 'card-value small ' + (Math.abs(missing) > 0.1 ? 'negative' : 'positive');
                
                // Positions
                document.getElementById('userPosCount').textContent = data.open_positions_count || 0;
                const posContainer = document.getElementById('userPositions');
                if (data.open_positions && data.open_positions.length > 0) {
                    let html = '';
                    for (const pos of data.open_positions) {
                        const pnl = parseFloat(pos.pnl || 0);
                        const pnlClass = pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
                        html += `<div class="log-entry">
                            <span style="min-width: 80px; color: #58a6ff;">${pos.symbol?.split('/')[0] || '-'}</span>
                            <span style="min-width: 60px;" class="badge ${pos.direction === 'LONG' ? 'badge-long' : 'badge-short'}">${pos.direction}</span>
                            <span style="min-width: 80px;">$${(pos.amount || 0).toFixed(2)}</span>
                            <span style="min-width: 100px;" class="${pnlClass}">${formatPnl(pnl)}</span>
                            <span style="color: #8b949e;">${formatTime(pos.opened_at)}</span>
                        </div>`;
                    }
                    posContainer.innerHTML = html;
                } else {
                    posContainer.innerHTML = '<div class="no-data">No open positions</div>';
                }
                
                // History
                document.getElementById('userHistCount').textContent = data.history_count || 0;
                const histContainer = document.getElementById('userHistory');
                if (data.history && data.history.length > 0) {
                    let html = '';
                    for (const trade of data.history) {
                        const pnl = parseFloat(trade.pnl || 0);
                        const pnlClass = pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
                        html += `<div class="log-entry">
                            <span style="min-width: 80px; color: #58a6ff;">${trade.symbol?.split('/')[0] || '-'}</span>
                            <span style="min-width: 60px;" class="badge ${trade.direction === 'LONG' ? 'badge-long' : 'badge-short'}">${trade.direction}</span>
                            <span style="min-width: 80px;">$${(trade.amount || 0).toFixed(2)}</span>
                            <span style="min-width: 100px;" class="${pnlClass}">${formatPnl(pnl)}</span>
                            <span style="min-width: 80px; color: #d29922;">${trade.reason || '-'}</span>
                            <span style="color: #8b949e;">${formatTime(trade.closed_at)}</span>
                        </div>`;
                    }
                    histContainer.innerHTML = html;
                } else {
                    histContainer.innerHTML = '<div class="no-data">No trade history</div>';
                }
                
                // User logs
                const logsContainer = document.getElementById('userLogs');
                if (data.user_logs && data.user_logs.length > 0) {
                    let html = '';
                    for (const log of data.user_logs) {
                        html += `<div class="log-entry">
                            <span class="log-time">${log.timestamp || '-'}</span>
                            <span class="log-level ${log.level}">${log.level}</span>
                            <span style="min-width: 80px; color: #58a6ff;">${log.symbol || '-'}</span>
                            <span class="log-message">${log.message || '-'}</span>
                        </div>`;
                    }
                    logsContainer.innerHTML = html;
                } else {
                    logsContainer.innerHTML = '<div class="no-data">No logs for this user</div>';
                }
                
            } catch (error) {
                console.error('Error looking up user:', error);
                alert('Error: ' + error.message);
            }
        }
        
        // Allow Enter key to trigger lookup
        document.getElementById('userIdInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') lookupUser();
        });
        
        // News functions
        async function fetchNews() {
            try {
                const response = await fetch('/api/news');
                const data = await response.json();
                
                renderNews(data.news || []);
                updateSentiment(data.sentiment || {});
                
                console.log('[Dashboard] News loaded:', data.count, 'items');
            } catch (error) {
                console.error('Error fetching news:', error);
                document.getElementById('newsList').innerHTML = 
                    '<div class="news-empty">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π</div>';
            }
        }
        
        function renderNews(news) {
            const container = document.getElementById('newsList');
            
            if (!news || news.length === 0) {
                container.innerHTML = '<div class="news-empty">üì≠ –ù–µ—Ç –Ω–æ–≤–æ—Å—Ç–µ–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>';
                return;
            }
            
            let html = '';
            for (const item of news) {
                const sentimentClass = getSentimentClass(item.sentiment_value);
                const impactClass = item.impact.toLowerCase();
                const timeAgo = formatTimeAgo(item.timestamp);
                const isTwitter = item.source.includes('@') || item.source.includes('üê¶');
                const sourceClass = isTwitter ? 'news-source twitter' : 'news-source';
                
                html += `
                    <div class="news-item" onclick="window.open('${item.url || '#'}', '_blank')">
                        <div class="news-item-header">
                            <span class="${sourceClass}">${item.source}</span>
                            <span class="news-time">${timeAgo}</span>
                        </div>
                        <div class="news-item-title">${escapeHtml(item.title)}</div>
                        <div class="news-item-footer">
                            <div class="news-tags">
                                ${item.coins.map(c => `<span class="news-tag coin">${c}</span>`).join('')}
                                <span class="news-tag ${sentimentClass}">${item.sentiment}</span>
                            </div>
                            <span class="news-impact ${impactClass}">${item.impact}</span>
                        </div>
                        ${item.keywords.length > 0 ? `<div class="news-keywords">${item.keywords.slice(0, 3).join(' ')}</div>` : ''}
                    </div>
                `;
            }
            container.innerHTML = html;
        }
        
        function updateSentiment(sentiment) {
            const badge = document.getElementById('newsSentiment');
            const icon = document.getElementById('sentimentIcon');
            const text = document.getElementById('sentimentText');
            const score = document.getElementById('sentimentScore');
            
            const trend = sentiment.trend || 'NEUTRAL';
            const scoreVal = sentiment.score || 0;
            
            // Update classes
            badge.className = 'news-sentiment ' + trend.toLowerCase();
            
            // Update content
            if (trend === 'BULLISH') {
                icon.textContent = 'üìà';
            } else if (trend === 'BEARISH') {
                icon.textContent = 'üìâ';
            } else {
                icon.textContent = '‚öñÔ∏è';
            }
            
            text.textContent = trend;
            score.textContent = `(${scoreVal > 0 ? '+' : ''}${scoreVal})`;
        }
        
        function getSentimentClass(value) {
            if (value >= 1) return 'bullish';
            if (value <= -1) return 'bearish';
            return 'neutral';
        }
        
        function formatTimeAgo(isoString) {
            if (!isoString) return '';
            
            try {
                const date = new Date(isoString);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                
                if (diffMins < 1) return '—Å–µ–π—á–∞—Å';
                if (diffMins < 60) return `${diffMins}–º`;
                if (diffHours < 24) return `${diffHours}—á`;
                return `${Math.floor(diffHours / 24)}–¥`;
            } catch {
                return '';
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Initial fetch
        refreshAll();
        fetchNews();
        
        // Auto-refresh
        setInterval(fetchStats, 3000);
        setInterval(fetchExtended, 5000);
        setInterval(fetchTrades, 5000);
        setInterval(fetchLogs, 10000);
        setInterval(fetchWinrateBreakdown, 15000);
        setInterval(fetchNews, 30000);  // Refresh news every 30 seconds
    </script>
</body>
</html>
