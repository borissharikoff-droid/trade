<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YULA Trading Bot | Dashboard</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: rgba(10, 15, 20, 0.92);
            --bg-secondary: rgba(15, 25, 35, 0.85);
            --bg-panel: rgba(18, 28, 38, 0.75);
            --bg-card: rgba(0, 0, 0, 0.3);
            --bg-card-hover: rgba(0, 255, 136, 0.05);
            --border-color: rgba(0, 255, 136, 0.12);
            --border-hover: rgba(0, 255, 136, 0.35);
            --accent: #00ff88;
            --accent-dim: rgba(0, 255, 136, 0.6);
            --accent-bg: rgba(0, 255, 136, 0.1);
            --positive: #00ff88;
            --negative: #ff4757;
            --warning: #ffa502;
            --info: #58a6ff;
            --purple: #a855f7;
            --text-primary: #e8f0f0;
            --text-secondary: rgba(232, 240, 240, 0.65);
            --text-muted: rgba(232, 240, 240, 0.4);
            --glass-blur: blur(20px);
            --shadow-glow: 0 0 30px rgba(0, 255, 136, 0.1);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #080c10;
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Animated Background */
        .bg-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: -1;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(0, 255, 136, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(88, 166, 255, 0.06) 0%, transparent 50%),
                linear-gradient(180deg, #080c10 0%, #0a1015 50%, #0c1218 100%);
        }
        
        .bg-grid {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: -1;
            background-image: 
                linear-gradient(rgba(0, 255, 136, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 136, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: gridMove 20s linear infinite;
        }
        
        @keyframes gridMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }
        
        .container {
            max-width: 1920px;
            margin: 0 auto;
            padding: 12px;
            position: relative;
            z-index: 1;
        }
        
        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 20px;
            background: var(--bg-primary);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
            box-shadow: var(--shadow-glow);
            position: relative;
            z-index: 100;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-icon {
            width: 36px; height: 36px;
            background: linear-gradient(135deg, var(--accent), #00cc6a);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.4);
        }
        
        .logo-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent), #58a6ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 3px;
        }
        
        .logo-version {
            font-size: 0.6rem;
            color: var(--text-muted);
            background: var(--bg-card);
            padding: 3px 8px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.2);
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--accent);
        }
        
        .status-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--accent);
            box-shadow: 0 0 10px var(--accent);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.85); }
        }
        
        .header-center {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .quick-stat {
            text-align: center;
            padding: 0 16px;
            border-right: 1px solid var(--border-color);
        }
        
        .quick-stat:last-child { border-right: none; }
        
        .quick-stat-label {
            font-size: 0.6rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 2px;
        }
        
        .quick-stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .quick-stat-value.positive { color: var(--positive); }
        .quick-stat-value.negative { color: var(--negative); }
        
        .quick-stat-delta {
            font-size: 0.65rem;
            font-family: 'JetBrains Mono', monospace;
            margin-top: 2px;
            min-height: 14px;
        }
        .quick-stat-delta.up { color: var(--positive); }
        .quick-stat-delta.down { color: var(--negative); }
        .quick-stat-delta.neutral { color: var(--text-muted); }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .btn.spinning svg {
            animation: spin 0.8s linear infinite;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .time-display {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: var(--text-secondary);
            padding: 8px 14px;
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 9px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.25s ease;
        }
        
        .btn:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-hover);
            color: var(--text-primary);
            transform: translateY(-1px);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.15), rgba(0, 255, 136, 0.05));
            border-color: rgba(0, 255, 136, 0.3);
            color: var(--accent);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.25), rgba(0, 255, 136, 0.1));
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
        }
        
        .btn svg { width: 14px; height: 14px; }
        
        /* Dropdown - FIXED z-index */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: calc(100% + 6px);
            background: var(--bg-primary);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            min-width: 200px;
            z-index: 99999;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.6), var(--shadow-glow);
            overflow: hidden;
        }
        
        .dropdown-menu.show { display: block; }
        
        .dropdown-title {
            padding: 12px 16px;
            font-size: 0.7rem;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border-color);
            text-transform: uppercase;
            letter-spacing: 1px;
            background: rgba(0, 0, 0, 0.2);
        }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .dropdown-item:hover {
            background: var(--accent-bg);
            color: var(--text-primary);
        }
        
        .dropdown-item span { font-size: 1rem; }
        
        .dropdown-divider {
            height: 1px;
            background: var(--border-color);
            margin: 4px 0;
        }
        
        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 16px;
        }
        
        @media (max-width: 1400px) {
            .main-layout { grid-template-columns: 1fr 320px; }
        }
        
        @media (max-width: 1200px) {
            .main-layout { grid-template-columns: 1fr; }
            .sidebar { max-height: 600px; }
        }
        
        .main-content { min-width: 0; }
        
        .sidebar {
            position: sticky;
            top: 12px;
            height: calc(100vh - 100px);
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        /* Tabs */
        .main-tabs {
            display: flex;
            gap: 4px;
            padding: 6px;
            background: var(--bg-primary);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 16px;
        }
        
        .main-tab {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.25s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .main-tab:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }
        
        .main-tab.active {
            background: linear-gradient(135deg, var(--accent), #00cc6a);
            color: #0a0f14;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Panel */
        .panel {
            background: var(--bg-panel);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            margin-bottom: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .panel:hover {
            border-color: var(--border-hover);
            box-shadow: var(--shadow-glow);
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            background: rgba(0, 0, 0, 0.25);
        }
        
        .panel-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .panel-title-icon { font-size: 1.1rem; }
        
        .panel-badge {
            padding: 4px 10px;
            background: var(--accent-bg);
            border: 1px solid rgba(0, 255, 136, 0.2);
            border-radius: 6px;
            font-size: 0.7rem;
            color: var(--accent);
        }
        
        .panel-content { padding: 18px; }
        
        /* Section */
        .section-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            padding: 12px 16px;
            background: var(--bg-primary);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-icon { font-size: 1rem; }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .stat-card {
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 18px;
            transition: all 0.25s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(135deg, transparent 50%, rgba(0, 255, 136, 0.02) 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .stat-card:hover {
            border-color: var(--border-color);
            transform: translateY(-2px);
        }
        
        .stat-card:hover::before { opacity: 1; }
        
        .stat-card.highlight {
            border-left: 3px solid var(--accent);
        }
        
        .stat-card.highlight-info { border-left-color: var(--info); }
        .stat-card.highlight-warning { border-left-color: var(--warning); }
        .stat-card.highlight-purple { border-left-color: var(--purple); }
        
        .stat-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .stat-label-icon { font-size: 0.9rem; }
        
        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
        }
        
        .stat-value.sm { font-size: 1.2rem; }
        .stat-value.xs { font-size: 1rem; }
        .stat-value.positive { color: var(--positive); }
        .stat-value.negative { color: var(--negative); }
        .stat-value.warning { color: var(--warning); }
        .stat-value.info { color: var(--info); }
        .stat-value.purple { color: var(--purple); }
        
        .stat-sub {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 4px;
        }
        
        .stat-trend {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 4px;
            margin-top: 6px;
        }
        
        .stat-trend.up {
            background: rgba(0, 255, 136, 0.1);
            color: var(--positive);
        }
        
        .stat-trend.down {
            background: rgba(255, 71, 87, 0.1);
            color: var(--negative);
        }
        
        /* Two Column Stats */
        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .stat-pair {
            display: flex;
            gap: 8px;
        }
        
        /* Reasons */
        .reasons-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        @media (max-width: 768px) {
            .reasons-grid { grid-template-columns: 1fr; }
        }
        
        .reasons-list {
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 16px;
        }
        
        .reasons-list h3 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 14px;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .reasons-list h3.wins { color: var(--positive); }
        .reasons-list h3.losses { color: var(--negative); }
        
        .reason-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            font-size: 0.8rem;
        }
        
        .reason-item:last-child { border-bottom: none; }
        
        .reason-name { 
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .reason-bar {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 2px;
            margin: 0 12px;
            overflow: hidden;
        }
        
        .reason-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s ease;
        }
        
        .reason-bar-fill.win { background: var(--positive); }
        .reason-bar-fill.loss { background: var(--negative); }
        
        .reason-count { 
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary); 
            font-weight: 600;
            min-width: 30px;
            text-align: right;
        }
        
        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }
        
        .data-table th {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            background: rgba(0, 0, 0, 0.25);
            position: sticky;
            top: 0;
        }
        
        .data-table td {
            padding: 14px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            color: var(--text-secondary);
        }
        
        .data-table tr:hover td {
            background: var(--bg-card-hover);
        }
        
        .data-table th.sortable { cursor: pointer; }
        .data-table th.sortable:hover { color: var(--text-primary); }
        .data-table th.sorted-asc::after { content: ' ‚Üë'; color: var(--accent); }
        .data-table th.sorted-desc::after { content: ' ‚Üì'; color: var(--accent); }
        
        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .badge-long { background: rgba(0, 255, 136, 0.12); color: var(--positive); }
        .badge-short { background: rgba(255, 71, 87, 0.12); color: var(--negative); }
        .badge-on { background: rgba(0, 255, 136, 0.12); color: var(--positive); }
        .badge-off { background: rgba(139, 148, 158, 0.12); color: var(--text-muted); }
        .badge-auto { background: rgba(168, 85, 247, 0.12); color: var(--purple); }
        
        .pnl-positive { color: var(--positive); font-family: 'JetBrains Mono', monospace; }
        .pnl-negative { color: var(--negative); font-family: 'JetBrains Mono', monospace; }
        
        /* Logs */
        .logs-container {
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            max-height: 350px;
            overflow-y: auto;
        }
        
        .log-entry {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            display: flex;
            gap: 14px;
            align-items: flex-start;
            transition: background 0.2s;
        }
        
        .log-entry:last-child { border-bottom: none; }
        .log-entry:hover { background: var(--bg-card-hover); }
        
        .log-time { color: var(--text-muted); min-width: 130px; flex-shrink: 0; }
        .log-level { min-width: 70px; font-weight: 600; flex-shrink: 0; }
        .log-level.INFO { color: var(--info); }
        .log-level.WARNING { color: var(--warning); }
        .log-level.ERROR { color: var(--negative); }
        .log-level.CRITICAL { color: #ff0055; }
        .log-message { color: var(--text-secondary); word-break: break-word; line-height: 1.4; }
        
        .log-tabs {
            display: flex;
            gap: 4px;
        }
        
        .log-tab {
            padding: 7px 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .log-tab:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }
        
        .log-tab.active {
            background: var(--accent-bg);
            color: var(--accent);
            border-color: rgba(0, 255, 136, 0.3);
        }
        
        /* Alerts */
        .alerts-panel {
            border-color: rgba(255, 71, 87, 0.3);
            animation: alertGlow 3s ease-in-out infinite;
        }
        
        @keyframes alertGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 71, 87, 0.1); }
            50% { box-shadow: 0 0 25px rgba(255, 71, 87, 0.2); }
        }
        
        .alerts-panel .panel-title { color: var(--negative); }
        
        .alert-badge {
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .alert-badge.critical { background: rgba(255, 0, 85, 0.15); color: #ff0055; }
        .alert-badge.error { background: rgba(255, 71, 87, 0.15); color: var(--negative); }
        .alert-badge.warning { background: rgba(255, 165, 2, 0.15); color: var(--warning); }
        
        .alert-pattern {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 71, 87, 0.08);
            border: 1px solid rgba(255, 71, 87, 0.2);
            border-radius: 8px;
            padding: 8px 14px;
            font-size: 0.75rem;
            margin: 0 8px 8px 0;
        }
        
        .alert-pattern.warning {
            background: rgba(255, 165, 2, 0.08);
            border-color: rgba(255, 165, 2, 0.2);
        }
        
        .alert-pattern-count {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            color: var(--negative);
        }
        
        .alert-pattern.warning .alert-pattern-count { color: var(--warning); }
        
        /* User Input */
        .user-input {
            padding: 10px 14px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.85rem;
            font-family: 'JetBrains Mono', monospace;
            width: 180px;
            transition: all 0.2s;
        }
        
        .user-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.1);
        }
        
        .user-input::placeholder { color: var(--text-muted); }
        
        /* Users Summary */
        .users-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .summary-card {
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            transition: all 0.2s;
        }
        
        .summary-card:hover {
            border-color: var(--border-color);
        }
        
        .summary-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 6px;
            letter-spacing: 0.5px;
        }
        
        .summary-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .users-table-container {
            max-height: 600px;
            overflow-y: auto;
            border-radius: 12px;
        }
        
        /* Sidebar Panels */
        .sidebar-panel {
            background: var(--bg-panel);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .sidebar-panel:hover {
            border-color: var(--border-hover);
        }
        
        .sidebar-header {
            padding: 14px 18px;
            border-bottom: 1px solid var(--border-color);
            background: rgba(0, 0, 0, 0.25);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sidebar-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        
        /* Live Positions */
        .position-card {
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }
        
        .position-card:hover {
            border-color: var(--border-color);
        }
        
        .position-card:last-child { margin-bottom: 0; }
        
        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .position-symbol {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
        }
        
        .position-details {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .position-pnl {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }
        
        /* News Panel */
        .news-item {
            padding: 14px;
            border-radius: 10px;
            margin-bottom: 10px;
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.03);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .news-item:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-color);
        }
        
        .news-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .news-source {
            font-size: 0.7rem;
            font-weight: 500;
            color: var(--accent);
        }
        
        .news-source.twitter { color: #1DA1F2; }
        
        .news-time {
            font-size: 0.6rem;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .news-title {
            font-size: 0.8rem;
            color: var(--text-primary);
            line-height: 1.4;
            margin-bottom: 10px;
        }
        
        .news-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .news-tag {
            font-size: 0.6rem;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .news-tag.coin { background: rgba(88, 166, 255, 0.12); color: var(--info); }
        .news-tag.bullish { background: rgba(0, 255, 136, 0.12); color: var(--positive); }
        .news-tag.bearish { background: rgba(255, 71, 87, 0.12); color: var(--negative); }
        .news-tag.neutral { background: rgba(139, 148, 158, 0.12); color: var(--text-muted); }
        
        .news-impact {
            font-size: 0.6rem;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .news-impact.critical { background: rgba(255, 71, 87, 0.15); color: var(--negative); }
        .news-impact.high { background: rgba(255, 165, 2, 0.15); color: var(--warning); }
        .news-impact.medium { background: rgba(88, 166, 255, 0.12); color: var(--info); }
        .news-impact.low { background: rgba(139, 148, 158, 0.12); color: var(--text-muted); }
        
        .sentiment-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.7rem;
            padding: 5px 12px;
            border-radius: 8px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .sentiment-badge.bullish { background: rgba(0, 255, 136, 0.12); color: var(--positive); }
        .sentiment-badge.bearish { background: rgba(255, 71, 87, 0.12); color: var(--negative); }
        .sentiment-badge.neutral { background: rgba(88, 166, 255, 0.12); color: var(--info); }
        
        /* Chart Container */
        .chart-container {
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 16px;
            height: 200px;
            position: relative;
        }
        
        /* Streak */
        .streak-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .streak-win { background: rgba(0, 255, 136, 0.12); color: var(--positive); }
        .streak-loss { background: rgba(255, 71, 87, 0.12); color: var(--negative); }
        
        /* Loading & Empty */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 40px;
            color: var(--text-muted);
        }
        
        .spinner {
            width: 20px; height: 20px;
            border: 2px solid rgba(0, 255, 136, 0.15);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .no-data {
            color: var(--text-muted);
            font-style: italic;
            padding: 30px;
            text-align: center;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.2); border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: rgba(0, 255, 136, 0.25); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0, 255, 136, 0.4); }
        
        /* Share Card */
        #shareCard {
            position: fixed;
            left: -9999px;
            top: 0;
            width: 520px;
            padding: 28px;
            background: linear-gradient(135deg, #080c10 0%, #0f1922 100%);
            border: 1px solid var(--border-color);
            border-radius: 16px;
        }
        
        .share-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 14px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .share-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.3rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent), #58a6ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .share-date { font-size: 0.75rem; color: var(--text-muted); }
        
        .share-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }
        
        .share-stat {
            background: var(--bg-card);
            padding: 16px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.03);
        }
        
        .share-stat-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 6px;
        }
        
        .share-stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.4rem;
            font-weight: 700;
        }
        
        .share-footer {
            margin-top: 18px;
            padding-top: 14px;
            border-top: 1px solid var(--border-color);
            font-size: 0.65rem;
            color: var(--text-muted);
            text-align: center;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 8px; }
            .header { padding: 12px 16px; }
            .logo-text { font-size: 1.2rem; }
            .header-center { display: none; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .stat-card { padding: 14px; }
            .stat-value { font-size: 1.2rem; }
            .main-tabs { gap: 2px; padding: 4px; }
            .main-tab { padding: 10px 14px; font-size: 0.75rem; }
            .data-table { font-size: 0.7rem; }
            .data-table th, .data-table td { padding: 10px; }
            .quick-stat { padding: 0 10px; }
            .time-display { display: none; }
        }
    </style>
</head>
<body>
    <div class="bg-container"></div>
    <div class="bg-grid"></div>
    
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">üìä</div>
                <span class="logo-text">YULA</span>
                <span class="logo-version">v2.1</span>
                <div class="status-indicator">
                    <span class="status-dot"></span>
                    <span>LIVE</span>
                </div>
            </div>
            
            <div class="header-center">
                <div class="quick-stat">
                    <div class="quick-stat-label">Win Rate <span style="color:var(--text-muted);font-size:0.65rem;">(all time)</span></div>
                    <div class="quick-stat-value positive" id="headerWinRate">-</div>
                    <div class="quick-stat-delta" id="headerWinRateDelta"></div>
                </div>
                <div class="quick-stat">
                    <div class="quick-stat-label">Today PnL <span style="color:var(--text-muted);font-size:0.65rem;">(today)</span></div>
                    <div class="quick-stat-value" id="headerTodayPnl">-</div>
                    <div class="quick-stat-delta" id="headerTodayPnlDelta"></div>
                </div>
                <div class="quick-stat">
                    <div class="quick-stat-label">Open Pos</div>
                    <div class="quick-stat-value info" id="headerOpenPos">-</div>
                </div>
            </div>
            
            <div class="header-actions">
                <span class="time-display" id="lastUpdate">-</span>
                
                <button class="btn" onclick="refreshAll()" id="btnRefresh">
                    <svg viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                        <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966a.25.25 0 0 1 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                    </svg>
                    Refresh
                </button>
                
                <div class="dropdown">
                    <button class="btn" onclick="toggleDropdown('exportMenu')">
                        <svg viewBox="0 0 16 16" fill="currentColor">
                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                        </svg>
                        Export
                    </button>
                    <div class="dropdown-menu" id="exportMenu">
                        <div class="dropdown-title">üì• Export Logs</div>
                        <div class="dropdown-item" onclick="exportLogs(1, 'hours')"><span>üïê</span> Last 1 hour</div>
                        <div class="dropdown-item" onclick="exportLogs(6, 'hours')"><span>üïï</span> Last 6 hours</div>
                        <div class="dropdown-item" onclick="exportLogs(24, 'hours')"><span>üìÖ</span> Last 24 hours</div>
                        <div class="dropdown-divider"></div>
                        <div class="dropdown-item" onclick="exportLogs(7, 'days')"><span>üìÜ</span> Last 7 days</div>
                        <div class="dropdown-item" onclick="exportLogs(30, 'days')"><span>üìÜ</span> Last 30 days</div>
                        <div class="dropdown-divider"></div>
                        <div class="dropdown-item" onclick="exportLogs(0, 'all')"><span>üì¶</span> ALL logs</div>
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="shareStats()" id="btnShare">
                    <svg viewBox="0 0 16 16" fill="currentColor">
                        <path d="M13.5 1a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.499 2.499 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5z"/>
                    </svg>
                    Share
                </button>
            </div>
        </header>
        
        <!-- Main Tabs -->
        <div class="main-tabs">
            <button class="main-tab active" onclick="switchTab('dashboard')">
                <span>üìä</span> Dashboard
            </button>
            <button class="main-tab" onclick="switchTab('analytics')">
                <span>üìà</span> Analytics
            </button>
            <button class="main-tab" onclick="switchTab('users')">
                <span>üë•</span> Users
            </button>
            <button class="main-tab" onclick="switchTab('logs')">
                <span>üìù</span> Logs
            </button>
            <button class="main-tab" onclick="switchTab('ai')">
                <span>ü§ñ</span> AI Brain
            </button>
        </div>
        
        <div class="main-layout">
            <div class="main-content">
                
                <!-- Dashboard Tab -->
                <div id="tab-dashboard" class="tab-content active">
                    
                    <!-- Alerts -->
                    <div class="panel alerts-panel" id="alertsSection" style="display: none;">
                        <div class="panel-header">
                            <span class="panel-title"><span class="panel-title-icon">üö®</span> Active Alerts</span>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <span class="alert-badge critical" id="criticalCount" style="display: none;">0</span>
                                <span class="alert-badge error" id="errorCount" style="display: none;">0</span>
                                <span class="alert-badge warning" id="warningCount" style="display: none;">0</span>
                                <button class="btn" onclick="toggleAlerts()" id="alertsToggle">Hide</button>
                            </div>
                        </div>
                        <div class="panel-content" id="alertsContent">
                            <div id="alertPatterns" style="margin-bottom: 12px;"></div>
                            <div class="logs-container" id="alertsContainer" style="max-height: 200px;">
                                <div class="no-data">Loading...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Current State -->
                    <div class="section-title"><span class="section-icon">üìä</span> Current State</div>
                    <div class="stats-grid">
                        <div class="stat-card highlight-info">
                            <div class="stat-label"><span class="stat-label-icon">üîì</span> Open Positions</div>
                            <div class="stat-value info" id="openDeals">-</div>
                            <div class="stat-sub" id="openDealsSub">- users</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label"><span class="stat-label-icon">üìä</span> Long / Short</div>
                            <div class="stat-value sm">
                                <span class="pnl-positive" id="posLong">-</span>
                                <span style="color: var(--text-muted);"> / </span>
                                <span class="pnl-negative" id="posShort">-</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label"><span class="stat-label-icon">üíµ</span> Positions Value</div>
                            <div class="stat-value sm" id="positionsValue">-</div>
                            <div class="stat-sub" id="unrealizedPnl">-</div>
                        </div>
                        <div class="stat-card highlight">
                            <div class="stat-label"><span class="stat-label-icon">üí∞</span> Total PnL</div>
                            <div class="stat-value" id="totalPnl">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label"><span class="stat-label-icon">üìà</span> Today PnL</div>
                            <div class="stat-value" id="todayPnl">-</div>
                            <div class="stat-sub" id="todayTrades">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label"><span class="stat-label-icon">üî•</span> Streak</div>
                            <div class="stat-value" id="streak">-</div>
                        </div>
                    </div>
                    
                    <!-- Trading Performance (merged Signal Analysis + Trading Results + Records) -->
                    <div class="section-title"><span class="section-icon">üìà</span> Trading Performance</div>
                    <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
                        <div class="stat-card highlight">
                            <div class="stat-label"><span class="stat-label-icon">üèÜ</span> Win Rate</div>
                            <div class="stat-value" id="winRate">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label"><span class="stat-label-icon">‚úÖ</span> Wins / Losses</div>
                            <div class="stat-value xs">
                                <span class="pnl-positive" id="profitable">-</span>
                                <span style="color: var(--text-muted);"> / </span>
                                <span class="pnl-negative" id="losing">-</span>
                            </div>
                            <div class="stat-sub" id="totalClosed">- closed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label"><span class="stat-label-icon">üìä</span> Profit Factor</div>
                            <div class="stat-value sm" id="profitFactor">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label"><span class="stat-label-icon">üíµ</span> Avg Win / Loss</div>
                            <div class="stat-value xs">
                                <span class="pnl-positive" id="avgWin">-</span>
                                <span style="color: var(--text-muted);"> / </span>
                                <span class="pnl-negative" id="avgLoss">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-top: 8px;">
                        <div class="stat-card">
                            <div class="stat-label"><span class="stat-label-icon">üöÄ</span> Best Trade</div>
                            <div class="stat-value sm positive" id="bestTrade">-</div>
                            <div class="stat-sub" id="bestTradeInfo">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label"><span class="stat-label-icon">üíÄ</span> Worst Trade</div>
                            <div class="stat-value sm negative" id="worstTrade">-</div>
                            <div class="stat-sub" id="worstTradeInfo">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label"><span class="stat-label-icon">üíé</span> Volume</div>
                            <div class="stat-value sm" id="totalVolume">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label"><span class="stat-label-icon">ü§ñ</span> Signals</div>
                            <div class="stat-value xs info" id="analyzed">-</div>
                            <div class="stat-sub"><span id="validSetups">-</span> valid ¬∑ <span id="rejected">-</span> rejected ¬∑ <span id="accepted">-</span> sent ¬∑ <span id="bybitOpened">-</span> bybit</div>
                        </div>
                    </div>
                    <div style="display: none;" id="validSetupsPct"></div>
                    <div style="display: none;" id="rejectedPct"></div>
                    
                    <!-- Market Analysis -->
                    <div class="section-title"><span class="section-icon">üß†</span> Market Analysis</div>
                    <div class="reasons-grid">
                        <div class="reasons-list">
                            <h3 class="wins"><span>üìà</span> Why We Win</h3>
                            <div id="winFactors"><div class="no-data">AI is learning...</div></div>
                        </div>
                        <div class="reasons-list">
                            <h3 class="losses"><span>üìâ</span> Why We Lose</h3>
                            <div id="lossFactors"><div class="no-data">AI is learning...</div></div>
                        </div>
                    </div>
                    
                    <!-- Close Reasons (technical) -->
                    <div class="section-title" style="margin-top: 12px;"><span class="section-icon">üìã</span> Close Reasons</div>
                    <div class="reasons-grid">
                        <div class="reasons-list">
                            <h3 class="wins"><span>‚úÖ</span> Winning</h3>
                            <div id="winReasons"><div class="no-data">No data</div></div>
                        </div>
                        <div class="reasons-list">
                            <h3 class="losses"><span>‚ùå</span> Losing</h3>
                            <div id="lossReasons"><div class="no-data">No data</div></div>
                        </div>
                    </div>
                    
                    <!-- Recent Trades -->
                    <div class="panel" style="margin-top: 16px;">
                        <div class="panel-header">
                            <span class="panel-title"><span class="panel-title-icon">üìú</span> Recent Trades</span>
                            <span class="panel-badge" id="tradesCount">0 trades</span>
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th>Direction</th>
                                        <th>Amount</th>
                                        <th>PnL</th>
                                        <th>Reason</th>
                                        <th>Time</th>
                                    </tr>
                                </thead>
                                <tbody id="tradesBody">
                                    <tr><td colspan="6" class="loading"><div class="spinner"></div> Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                </div>
                
                <!-- Analytics Tab -->
                <div id="tab-analytics" class="tab-content">
                    
                    <!-- Winrate Thresholds -->
                    <div class="section-title"><span class="section-icon">üéØ</span> Winrate Thresholds</div>
                    <div class="stats-grid" style="grid-template-columns: repeat(5, 1fr);">
                        <div class="stat-card">
                            <div class="stat-label">>60% WR</div>
                            <div class="stat-value sm" id="wr60">-</div>
                            <div class="stat-sub" id="wr60trades">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">>70% WR</div>
                            <div class="stat-value sm" id="wr70">-</div>
                            <div class="stat-sub" id="wr70trades">-</div>
                        </div>
                        <div class="stat-card highlight">
                            <div class="stat-label">>80% WR</div>
                            <div class="stat-value sm positive" id="wr80">-</div>
                            <div class="stat-sub" id="wr80trades">-</div>
                        </div>
                        <div class="stat-card highlight">
                            <div class="stat-label">>90% WR</div>
                            <div class="stat-value sm positive" id="wr90">-</div>
                            <div class="stat-sub" id="wr90trades">-</div>
                        </div>
                        <div class="stat-card highlight">
                            <div class="stat-label">>95% WR</div>
                            <div class="stat-value sm positive" id="wr95">-</div>
                            <div class="stat-sub" id="wr95trades">-</div>
                        </div>
                    </div>
                    
                    <!-- Performance Summary -->
                    <div class="section-title"><span class="section-icon">üìä</span> Performance Summary</div>
                    <div class="stats-grid" id="analyticsSummary" style="grid-template-columns: repeat(4, 1fr);">
                        <div class="stat-card"><div class="stat-label">Loading...</div></div>
                    </div>
                    
                    <!-- Top/Worst Symbols -->
                    <div id="topSymbols" style="margin-top: 16px;"></div>
                    <div id="worstSymbols"></div>
                    
                    <!-- Learning Analytics Section -->
                    <div class="section-title" style="margin-top: 24px;"><span class="section-icon">üß†</span> Learning Analytics</div>
                    <div id="learningSection">
                        <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
                            <div class="stat-card">
                                <div class="stat-label">Learning Score</div>
                                <div class="stat-value" id="learningScore">-</div>
                                <div class="stat-sub" id="learningStatus">Loading...</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Rules Learned</div>
                                <div class="stat-value sm" id="rulesLearned">-</div>
                                <div class="stat-sub">AI knowledge</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Patterns Found</div>
                                <div class="stat-value sm" id="patternsFound">-</div>
                                <div class="stat-sub">Trade patterns</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">AI Accuracy</div>
                                <div class="stat-value sm" id="aiAccuracy">-</div>
                                <div class="stat-sub">Predictions</div>
                            </div>
                        </div>
                        
                        <!-- Trends -->
                        <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr); margin-top: 12px;">
                            <div class="stat-card">
                                <div class="stat-label">Winrate Trend</div>
                                <div class="stat-value sm" id="winrateTrend">-</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">PnL Trend</div>
                                <div class="stat-value sm" id="pnlTrend">-</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Accuracy Trend</div>
                                <div class="stat-value sm" id="accuracyTrend">-</div>
                            </div>
                        </div>
                        
                        <!-- Recommendations -->
                        <div class="panel" style="margin-top: 12px; padding: 12px;">
                            <div style="font-weight: 600; margin-bottom: 8px;">üìã AI Recommendations</div>
                            <div id="learningRecommendations" style="font-size: 13px; color: var(--text-muted);">
                                Loading recommendations...
                            </div>
                        </div>
                    </div>
                    
                    <!-- PnL Chart -->
                    <div class="panel" style="margin-top: 20px;">
                        <div class="panel-header">
                            <span class="panel-title"><span class="panel-title-icon">üìà</span> PnL Over Time (30 days)</span>
                        </div>
                        <div class="panel-content">
                            <div class="chart-container" style="height: 300px;">
                                <canvas id="pnlChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- User Diagnostics -->
                    <div class="panel">
                        <div class="panel-header">
                            <span class="panel-title"><span class="panel-title-icon">üîç</span> User Diagnostics</span>
                            <div style="display: flex; gap: 8px;">
                                <input type="text" id="userIdInput" placeholder="Enter User ID" class="user-input">
                                <button class="btn btn-primary" onclick="lookupUser()">Lookup</button>
                            </div>
                        </div>
                        <div class="panel-content" id="userInfoContainer" style="display: none;">
                            <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
                                <div class="stat-card">
                                    <div class="stat-label">Balance</div>
                                    <div class="stat-value sm" id="userBalance">-</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Total Deposit</div>
                                    <div class="stat-value sm" id="userDeposit">-</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Total Profit</div>
                                    <div class="stat-value sm" id="userProfit">-</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Missing $</div>
                                    <div class="stat-value sm negative" id="userMissing">-</div>
                                </div>
                            </div>
                            <div style="margin-top: 16px;">
                                <h3 style="font-size: 0.8rem; margin-bottom: 10px; color: var(--text-muted);">Open Positions (<span id="userPosCount">0</span>)</h3>
                                <div class="logs-container" id="userPositions" style="max-height: 180px;">
                                    <div class="no-data">No positions</div>
                                </div>
                            </div>
                            <div style="margin-top: 16px;">
                                <h3 style="font-size: 0.8rem; margin-bottom: 10px; color: var(--text-muted);">Trade History (<span id="userHistCount">0</span>)</h3>
                                <div class="logs-container" id="userHistory" style="max-height: 220px;">
                                    <div class="no-data">No history</div>
                                </div>
                            </div>
                            <div style="margin-top: 16px;">
                                <h3 style="font-size: 0.8rem; margin-bottom: 10px; color: var(--text-muted);">User Activity Logs</h3>
                                <div class="logs-container" id="userLogs" style="max-height: 220px;">
                                    <div class="no-data">No logs</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
                
                <!-- Users Tab -->
                <div id="tab-users" class="tab-content">
                    <div class="users-summary">
                        <div class="summary-card">
                            <div class="summary-label">Total Users</div>
                            <div class="summary-value" id="totalUsers">-</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Total Equity</div>
                            <div class="summary-value" id="usersEquity">-</div>
                            <div class="summary-sub" id="usersEquitySub" style="font-size: 0.65rem; color: var(--text-muted);"></div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Total Deposits</div>
                            <div class="summary-value" id="usersDeposits">-</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Total PnL</div>
                            <div class="summary-value" id="usersTotalPnl">-</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Active Traders</div>
                            <div class="summary-value" id="activeTraders">-</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-label">Auto-Trade</div>
                            <div class="summary-value" id="autoTraders">-</div>
                        </div>
                    </div>
                    
                    <div class="panel">
                        <div class="panel-header">
                            <span class="panel-title"><span class="panel-title-icon">üë•</span> All Users</span>
                            <input type="text" id="userSearch" placeholder="Search by ID..." class="user-input" style="width: 150px;" oninput="filterUsers()">
                        </div>
                        <div class="users-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th class="sortable" onclick="sortUsers('user_id')">ID</th>
                                        <th class="sortable" onclick="sortUsers('balance')">Balance</th>
                                        <th class="sortable" onclick="sortUsers('total_deposit')">Deposit</th>
                                        <th class="sortable" onclick="sortUsers('total_trades')">Trades</th>
                                        <th class="sortable" onclick="sortUsers('wins')">W/L</th>
                                        <th class="sortable" onclick="sortUsers('winrate')">WR%</th>
                                        <th class="sortable" onclick="sortUsers('total_pnl')">PnL</th>
                                        <th class="sortable" onclick="sortUsers('open_positions')">Pos</th>
                                        <th class="sortable" onclick="sortUsers('trading')">Trading</th>
                                        <th class="sortable" onclick="sortUsers('auto_trade')">Auto</th>
                                    </tr>
                                </thead>
                                <tbody id="usersBody">
                                    <tr><td colspan="10" class="loading"><div class="spinner"></div> Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Logs Tab -->
                <div id="tab-logs" class="tab-content">
                    <div class="panel">
                        <div class="panel-header">
                            <span class="panel-title"><span class="panel-title-icon">üìù</span> Bot Logs</span>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <span class="panel-badge" id="logsCount">0 logs</span>
                                <div class="log-tabs">
                                    <button class="log-tab active" onclick="filterLogs('all')">All</button>
                                    <button class="log-tab" onclick="filterLogs('INFO')">Info</button>
                                    <button class="log-tab" onclick="filterLogs('WARNING')">Warning</button>
                                    <button class="log-tab" onclick="filterLogs('ERROR')">Error</button>
                                </div>
                            </div>
                        </div>
                        <div class="logs-container" id="logsContainer" style="max-height: calc(100vh - 300px);">
                            <div class="no-data">Loading logs...</div>
                        </div>
                    </div>
                </div>
                
                <!-- AI Brain Tab -->
                <div id="tab-ai" class="tab-content">
                    
                    <!-- Daily Summary (TOP - most important) -->
                    <div class="panel" style="margin-bottom: 16px; border: 1px solid var(--accent); border-radius: 12px;">
                        <div class="panel-header" style="background: linear-gradient(135deg, rgba(99,102,241,0.08), rgba(139,92,246,0.05));">
                            <span class="panel-title"><span class="panel-title-icon">üìã</span> Daily Summary</span>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <span class="panel-badge" id="aiInsightsCount">0</span>
                                <button class="btn" onclick="generateReport('yesterday')" id="btnGenReport" style="font-size: 0.7rem; padding: 4px 10px;">Generate Yesterday</button>
                                <button class="btn" onclick="generateReport('today')" style="font-size: 0.7rem; padding: 4px 10px;">Today</button>
                            </div>
                        </div>
                        <div class="panel-content" id="aiInsightsList" style="max-height: 700px; overflow-y: auto;">
                            <div class="no-data">No insights generated yet. Click "Generate Yesterday" to create a report.</div>
                        </div>
                    </div>

                    <!-- AI Status Header -->
                    <div class="stats-grid" style="grid-template-columns: repeat(7, 1fr); margin-bottom: 16px;">
                        <div class="stat-card">
                            <div class="stat-label">AI Status</div>
                            <div class="stat-value" id="aiStatus" style="font-size: 1.1rem;">‚è≥ Loading...</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Trades Analyzed</div>
                            <div class="stat-value" id="aiTradesAnalyzed" style="color: var(--info);">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">News Analyzed</div>
                            <div class="stat-value" id="aiNewsAnalyzed" style="color: var(--purple);">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">News Tracking</div>
                            <div class="stat-value" id="aiNewsTracking" style="color: var(--warning);">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Learned Rules</div>
                            <div class="stat-value" id="aiLearnedRules" style="color: var(--warning);">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Trade Patterns</div>
                            <div class="stat-value" id="aiTradePatterns" style="color: var(--accent);">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Prediction Accuracy</div>
                            <div class="stat-value" id="aiAccuracy" style="color: var(--positive);">0%</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        
                        <!-- Recent Trade Analyses -->
                        <div class="panel">
                            <div class="panel-header">
                                <span class="panel-title"><span class="panel-title-icon">üî¨</span> Trade Analyses</span>
                                <span class="panel-badge" id="aiAnalysesCount">0</span>
                            </div>
                            <div class="panel-content" id="aiAnalysesList" style="max-height: 500px; overflow-y: auto;">
                                <div class="no-data">No analyses yet</div>
                            </div>
                        </div>
                        
                        <!-- Learned Rules -->
                        <div class="panel">
                            <div class="panel-header">
                                <span class="panel-title"><span class="panel-title-icon">üß†</span> Learned Rules</span>
                                <span class="panel-badge" id="aiRulesCount">0</span>
                            </div>
                            <div class="panel-content" id="aiRulesList" style="max-height: 500px; overflow-y: auto;">
                                <div class="no-data">No rules learned yet</div>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- AI Knowledge (merged Symbol Patterns + News Impact) -->
                    <div class="panel" style="margin-top: 16px;">
                        <div class="panel-header">
                            <span class="panel-title"><span class="panel-title-icon">üß†</span> AI Knowledge</span>
                            <div style="display: flex; gap: 4px;">
                                <button class="btn log-tab active" onclick="switchKnowledgeTab('symbols', this)" style="font-size: 0.7rem; padding: 3px 8px;">Symbols</button>
                                <button class="btn log-tab" onclick="switchKnowledgeTab('news', this)" style="font-size: 0.7rem; padding: 3px 8px;">News Impact</button>
                            </div>
                        </div>
                        <div id="knowledgeSymbols" class="panel-content" style="max-height: 350px; overflow-y: auto;">
                            <div id="aiSymbolPatterns"><div class="no-data">No symbol patterns yet</div></div>
                        </div>
                        <div id="knowledgeNews" class="panel-content" style="max-height: 350px; overflow-y: auto; display: none;">
                            <div id="aiNewsPatterns"><div class="no-data">No news patterns yet</div></div>
                        </div>
                    </div>
                    
                    <!-- Pending News Tracking -->
                    <div class="panel" style="margin-top: 16px;">
                        <div class="panel-header">
                            <span class="panel-title"><span class="panel-title-icon">‚è≥</span> News Being Tracked</span>
                            <span class="panel-badge" id="aiPendingNewsCount">0</span>
                        </div>
                        <div style="padding: 8px 12px; font-size: 0.75rem; color: var(--text-secondary); background: var(--bg-card); border-bottom: 1px solid var(--border-color);">
                            üîç AI –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç RSS –Ω–æ–≤–æ—Å—Ç–∏ –∏ —á–µ—Ä–µ–∑ 15-30 –º–∏–Ω—É—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏—Ö –≤–ª–∏—è–Ω–∏–µ –Ω–∞ —Ü–µ–Ω—É
                        </div>
                        <div class="panel-content" id="aiPendingNews" style="max-height: 250px; overflow-y: auto;">
                            <div class="no-data">No news being tracked</div>
                        </div>
                    </div>
                    
                </div>
                
            </div>
            
            <!-- Sidebar -->
            <div class="sidebar">
                
                <!-- Live Positions -->
                <div class="sidebar-panel" style="flex: 0 0 auto; max-height: 45%;">
                    <div class="sidebar-header">
                        <span class="sidebar-title">üîì Live Positions</span>
                        <span class="panel-badge" id="livePositionsCount">0</span>
                    </div>
                    <div class="sidebar-content" id="livePositions">
                        <div class="no-data">No open positions</div>
                    </div>
                </div>
                
                <!-- News & Twitter -->
                <div class="sidebar-panel" style="flex: 1; min-height: 0;">
                    <div class="sidebar-header">
                        <span class="sidebar-title">üì∞ News & üê¶ Twitter</span>
                        <span class="sentiment-badge neutral" id="newsSentiment" title="BOB: Bearish or Bullish index 1-10">
                            <span id="sentimentIcon">‚öñÔ∏è</span>
                            <span id="sentimentText">BOB: 5/10 NEUTRAL</span>
                        </span>
                    </div>
                    <div class="sidebar-content" id="newsList">
                        <div class="loading"><div class="spinner"></div> Loading news...</div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
    
    <!-- Hidden Share Card -->
    <div id="shareCard">
        <div class="share-header">
            <span class="share-title">YULA Trading Stats</span>
            <span class="share-date" id="shareDate">-</span>
        </div>
        <div class="share-grid">
            <div class="share-stat">
                <div class="share-stat-label">Win Rate</div>
                <div class="share-stat-value" id="shareWinRate" style="color: var(--positive)">-</div>
            </div>
            <div class="share-stat">
                <div class="share-stat-label">Total PnL</div>
                <div class="share-stat-value" id="sharePnl">-</div>
            </div>
            <div class="share-stat">
                <div class="share-stat-label">Profitable</div>
                <div class="share-stat-value" style="color: var(--positive)" id="shareProfitable">-</div>
            </div>
            <div class="share-stat">
                <div class="share-stat-label">Losing</div>
                <div class="share-stat-value" style="color: var(--negative)" id="shareLosing">-</div>
            </div>
            <div class="share-stat">
                <div class="share-stat-label">Today's PnL</div>
                <div class="share-stat-value" id="shareTodayPnl">-</div>
            </div>
            <div class="share-stat">
                <div class="share-stat-label">Open Deals</div>
                <div class="share-stat-value" style="color: var(--info)" id="shareOpen">-</div>
            </div>
        </div>
        <div class="share-footer">Generated by YULA Trading Bot Dashboard</div>
    </div>
    
    <script>
        let currentStats = {};
        let currentExtended = {};
        let allLogs = [];
        let currentLogFilter = 'all';
        let allUsers = [];
        let usersSortField = 'balance';
        let usersSortDir = 'desc';
        let alertsExpanded = true;
        let pnlChart = null;
        
        // Utility Functions
        function formatPnl(value) {
            const num = parseFloat(value) || 0;
            const sign = num >= 0 ? '+' : '';
            return sign + '$' + num.toFixed(2);
        }

        function formatReasonLabel(raw) {
            if (!raw) return '-';
            let r = raw.toUpperCase().trim();
            // Strip prefixes
            for (const pfx of ['LINKED_', 'WS_', 'BYBIT_']) {
                if (r.startsWith(pfx)) { r = r.slice(pfx.length); break; }
            }
            const MAP = {
                'TP': 'üéØ Take Profit', 'TP1': 'üéØ TP1', 'TP2': 'üéØ TP2', 'TP3': 'üéØ TP3',
                'SL': 'üõë Stop Loss',
                'MANUAL': 'üë§ Manual', 'MANUAL_CLOSE': 'üë§ Manual',
                'CLOSE_ALL': 'üîÑ Close All',
                'CLOSED': 'üìä Exchange Close',
                'TRAILING': 'üìà Trailing', 'TRAILING_STOP': 'üìà Trailing',
                'PHANTOM_CLEANUP': 'üîß Cleanup', 'PHANTOM_OLD': 'üîß Cleanup',
                'MANUAL_PHANTOM_CLEANUP': 'üîß Cleanup', 'FULLY_CLOSED': 'üîß Cleanup',
                'MICRO_CLOSE': 'üîß Cleanup', 'FORCE_CLEANUP': 'üîß Cleanup'
            };
            if (MAP[r]) return MAP[r];
            if (r.startsWith('EARLY_EXIT')) return 'ü§ñ AI Exit';
            return raw.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        }
        
        function toMoscowTime(date) {
            const moscowOffset = 3 * 60;
            const utc = date.getTime() + (date.getTimezoneOffset() * 60000);
            return new Date(utc + (moscowOffset * 60000));
        }
        
        function formatTime(isoString) {
            if (!isoString) return '-';
            const date = toMoscowTime(new Date(isoString));
            return date.toLocaleString('ru-RU', { 
                hour: '2-digit', minute: '2-digit', second: '2-digit',
                day: '2-digit', month: '2-digit', hour12: false 
            });
        }
        
        function formatTime24(date) {
            const moscow = toMoscowTime(date);
            return moscow.toLocaleString('ru-RU', {
                hour: '2-digit', minute: '2-digit', second: '2-digit',
                day: '2-digit', month: '2-digit', year: 'numeric', hour12: false
            }) + ' MSK';
        }
        
        function formatTimeAgo(isoString) {
            if (!isoString) return '';
            try {
                const date = new Date(isoString);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                if (diffMins < 1) return 'now';
                if (diffMins < 60) return `${diffMins}m`;
                if (diffHours < 24) return `${diffHours}h`;
                return `${Math.floor(diffHours / 24)}d`;
            } catch { return ''; }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function renderMarkdown(text) {
            if (!text) return '';
            let html = escapeHtml(text);
            // Headings: ### Title
            html = html.replace(/^###\s*\*\*(.+?)\*\*/gm, '<h4 style="color:var(--accent);margin:12px 0 6px;font-size:0.9rem;">$1</h4>');
            html = html.replace(/^###\s+(.+)/gm, '<h4 style="color:var(--accent);margin:12px 0 6px;font-size:0.9rem;">$1</h4>');
            // Bold: **text**
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong style="color:var(--text-primary);">$1</strong>');
            // Italic: *text*
            html = html.replace(/(?<!\*)\*([^*]+?)\*(?!\*)/g, '<em>$1</em>');
            // Horizontal rule: ---
            html = html.replace(/^---$/gm, '<hr style="border:none;border-top:1px solid var(--border-color);margin:8px 0;">');
            // List items: - item or * item
            html = html.replace(/^[\-\*]\s+(.+)/gm, '<div style="padding-left:12px;margin:2px 0;">‚Ä¢ $1</div>');
            // Numbered list: 1. item
            html = html.replace(/^\d+\.\s+(.+)/gm, '<div style="padding-left:12px;margin:2px 0;">$&</div>');
            // Line breaks
            html = html.replace(/\n/g, '<br>');
            // Clean up multiple <br>
            html = html.replace(/(<br>){3,}/g, '<br><br>');
            return html;
        }
        
        // Dropdown
        function toggleDropdown(id) {
            const menu = document.getElementById(id);
            // Close all other dropdowns first
            document.querySelectorAll('.dropdown-menu').forEach(m => {
                if (m.id !== id) m.classList.remove('show');
            });
            menu.classList.toggle('show');
        }
        
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
            }
        });
        
        function exportLogs(value, unit) {
            let url = '/api/export_logs?';
            if (unit === 'hours') url += `hours=${value}`;
            else if (unit === 'days') url += `days=${value}`;
            else if (unit === 'all') url += 'all=1';
            window.location.href = url;
            document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
        }
        
        // Tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            event.target.closest('.main-tab').classList.add('active');
            
            if (tabName === 'users' && allUsers.length === 0) fetchUsers();
            if (tabName === 'ai' && !aiData) fetchAI();
            if (tabName === 'analytics') {
                fetchWinrateBreakdown();
                initPnlChart();
                fetchLearningData();
            }
        }
        
        // Alerts
        function toggleAlerts() {
            alertsExpanded = !alertsExpanded;
            document.getElementById('alertsContent').style.display = alertsExpanded ? 'block' : 'none';
            document.getElementById('alertsToggle').textContent = alertsExpanded ? 'Hide' : 'Show';
        }
        
        // Render Functions
        const REASON_ICONS = {
            'Take Profit': 'üéØ',
            'Stop Loss': 'üõë',
            'Manual Close': 'üë§',
            'Close All': 'üîÑ',
            'AI Early Exit': 'ü§ñ',
            'Exchange Close': 'üìä',
            'System Cleanup': 'üîß',
            'Trailing Stop': 'üìà',
            'Unknown': '‚ùì'
        };

        function renderReasons(reasons, containerId, isWin = true) {
            const container = document.getElementById(containerId);
            if (!reasons || Object.keys(reasons).length === 0) {
                container.innerHTML = '<div class="no-data">No data</div>';
                return;
            }
            
            const total = Object.values(reasons).reduce((a, b) => a + b, 0);
            const maxCount = Math.max(...Object.values(reasons));
            let html = '';
            for (const [reason, count] of Object.entries(reasons).slice(0, 8)) {
                const pct = (count / maxCount * 100).toFixed(0);
                const share = total > 0 ? (count / total * 100).toFixed(1) : '0';
                const icon = REASON_ICONS[reason] || 'üìã';
                html += `<div class="reason-item">
                    <span class="reason-name">${icon} ${reason || 'Unknown'}</span>
                    <div class="reason-bar">
                        <div class="reason-bar-fill ${isWin ? 'win' : 'loss'}" style="width: ${pct}%"></div>
                    </div>
                    <span class="reason-count">${count} <span style="color:var(--text-muted);font-size:0.75em">(${share}%)</span></span>
                </div>`;
            }
            container.innerHTML = html;
        }
        
        function renderMarketFactors(factors, containerId, isWin) {
            const container = document.getElementById(containerId);
            if (!factors || Object.keys(factors).length === 0) {
                container.innerHTML = '<div class="no-data">AI is learning...</div>';
                return;
            }
            
            const total = Object.values(factors).reduce((a, b) => a + b, 0);
            const maxCount = Math.max(...Object.values(factors));
            let html = '';
            for (const [factor, count] of Object.entries(factors).slice(0, 6)) {
                const pct = (count / maxCount * 100).toFixed(0);
                const share = total > 0 ? (count / total * 100).toFixed(1) : '0';
                html += `<div class="reason-item">
                    <span class="reason-name" style="font-size: 0.78rem; flex: 2;">${factor}</span>
                    <div class="reason-bar">
                        <div class="reason-bar-fill ${isWin ? 'win' : 'loss'}" style="width: ${pct}%"></div>
                    </div>
                    <span class="reason-count">${count} <span style="color:var(--text-muted);font-size:0.7em">(${share}%)</span></span>
                </div>`;
            }
            container.innerHTML = html;
        }

        function renderTrades(trades) {
            const tbody = document.getElementById('tradesBody');
            document.getElementById('tradesCount').textContent = (trades?.length || 0) + ' trades';
            
            if (!trades || trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">No trades yet</td></tr>';
                return;
            }
            
            let html = '';
            for (const trade of trades.slice(0, 20)) {
                const pnl = parseFloat(trade.pnl || 0);
                const pnlClass = pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
                const dirClass = trade.direction === 'LONG' ? 'badge-long' : 'badge-short';
                const symbol = trade.symbol ? trade.symbol.split('/')[0] : '-';
                const isAuto = trade.is_auto;
                
                html += `<tr>
                    <td style="color: var(--text-primary); font-weight: 500;">
                        ${symbol}
                        ${isAuto ? '<span class="badge badge-auto" style="margin-left: 6px;">AUTO</span>' : ''}
                    </td>
                    <td><span class="badge ${dirClass}">${trade.direction || '-'}</span></td>
                    <td style="font-family: 'JetBrains Mono', monospace;">$${(trade.amount || 0).toFixed(2)}</td>
                    <td class="${pnlClass}">${formatPnl(pnl)}</td>
                    <td>${formatReasonLabel(trade.reason)}</td>
                    <td style="color: var(--text-muted);">${formatTime(trade.closed_at)}</td>
                </tr>`;
            }
            tbody.innerHTML = html;
        }
        
        function renderLogs(logs) {
            const container = document.getElementById('logsContainer');
            let filteredLogs = logs;
            if (currentLogFilter !== 'all') {
                filteredLogs = logs.filter(l => l.level === currentLogFilter);
            }
            
            if (!filteredLogs || filteredLogs.length === 0) {
                container.innerHTML = '<div class="no-data">No logs</div>';
                return;
            }
            
            let html = '';
            for (const log of filteredLogs.slice(0, 150)) {
                html += `<div class="log-entry">
                    <span class="log-time">${log.timestamp || '-'}</span>
                    <span class="log-level ${log.level}">${log.level}</span>
                    <span class="log-message">${escapeHtml(log.message || '-')}</span>
                </div>`;
            }
            container.innerHTML = html;
        }
        
        function filterLogs(level) {
            currentLogFilter = level;
            document.querySelectorAll('.log-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            renderLogs(allLogs);
        }
        
        function renderLivePositions(positions) {
            const container = document.getElementById('livePositions');
            document.getElementById('livePositionsCount').textContent = positions?.length || 0;
            
            if (!positions || positions.length === 0) {
                container.innerHTML = '<div class="no-data">No open positions</div>';
                return;
            }
            
            let html = '';
            for (const pos of positions.slice(0, 15)) {
                const pnl = parseFloat(pos.pnl || 0);
                const pnlClass = pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
                const dirClass = pos.direction === 'LONG' ? 'badge-long' : 'badge-short';
                const symbol = pos.symbol ? pos.symbol.split('/')[0] : '-';
                
                html += `<div class="position-card">
                    <div class="position-header">
                        <span class="position-symbol">${symbol}</span>
                        <span class="badge ${dirClass}">${pos.direction}</span>
                    </div>
                    <div class="position-details">
                        <span>$${(pos.amount || 0).toFixed(2)}</span>
                        <span class="position-pnl ${pnlClass}">${formatPnl(pnl)}</span>
                    </div>
                </div>`;
            }
            container.innerHTML = html;
        }
        
        function renderNews(news) {
            const container = document.getElementById('newsList');
            if (!news || news.length === 0) {
                container.innerHTML = '<div class="no-data">üì≠ No news available</div>';
                return;
            }
            
            let html = '';
            for (const item of news) {
                const sentimentClass = item.sentiment_value >= 1 ? 'bullish' : item.sentiment_value <= -1 ? 'bearish' : 'neutral';
                const impactClass = item.impact?.toLowerCase() || 'low';
                const timeAgo = formatTimeAgo(item.timestamp);
                const isTwitter = item.source?.includes('@') || item.source?.includes('üê¶');
                
                html += `<div class="news-item" onclick="window.open('${item.url || '#'}', '_blank')">
                    <div class="news-item-header">
                        <span class="news-source ${isTwitter ? 'twitter' : ''}">${item.source || 'News'}</span>
                        <span class="news-time">${timeAgo}</span>
                    </div>
                    <div class="news-title">${escapeHtml(item.title)}</div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="news-tags">
                            ${(item.coins || []).map(c => `<span class="news-tag coin">${c}</span>`).join('')}
                            <span class="news-tag ${sentimentClass}">${item.sentiment || 'Neutral'}</span>
                        </div>
                        <span class="news-impact ${impactClass}">${item.impact || 'LOW'}</span>
                    </div>
                </div>`;
            }
            container.innerHTML = html;
        }
        
        function updateSentiment(sentiment) {
            const badge = document.getElementById('newsSentiment');
            const icon = document.getElementById('sentimentIcon');
            const text = document.getElementById('sentimentText');
            const trend = sentiment?.trend || 'NEUTRAL';
            badge.className = 'sentiment-badge ' + trend.toLowerCase();
            icon.textContent = trend === 'BULLISH' ? 'üìà' : trend === 'BEARISH' ? 'üìâ' : '‚öñÔ∏è';
            text.textContent = trend;
        }
        
        function updateBOB(bobIndex) {
            if (!bobIndex) return;
            const badge = document.getElementById('newsSentiment');
            const icon = document.getElementById('sentimentIcon');
            const text = document.getElementById('sentimentText');
            const value = bobIndex.value != null ? bobIndex.value : 5;
            const label = (bobIndex.label || 'NEUTRAL').toUpperCase();
            badge.className = 'sentiment-badge ' + (label === 'BULLISH' ? 'bullish' : label === 'BEARISH' ? 'bearish' : 'neutral');
            icon.textContent = label === 'BULLISH' ? 'üìà' : label === 'BEARISH' ? 'üìâ' : '‚öñÔ∏è';
            text.textContent = 'BOB: ' + value + '/10 ' + label;
        }
        
        // Fetch Functions
        async function fetchStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                currentStats = data;
                
                // Header stats
                document.getElementById('headerWinRate').textContent = (data.win_rate ?? 0) + '%';
                document.getElementById('headerOpenPos').textContent = data.positions_total ?? data.open_deals ?? 0;
                
                // Main stats
                document.getElementById('openDeals').textContent = data.positions_total ?? data.open_deals ?? 0;
                document.getElementById('openDealsSub').textContent = (data.positions_users ?? 0) + ' users';
                document.getElementById('posLong').textContent = data.positions_long ?? 0;
                document.getElementById('posShort').textContent = data.positions_short ?? 0;
                document.getElementById('positionsValue').textContent = '$' + (data.positions_value ?? 0).toLocaleString();
                
                const unrealizedPnl = data.positions_unrealized_pnl ?? 0;
                const unrealizedEl = document.getElementById('unrealizedPnl');
                unrealizedEl.textContent = 'Unrealized: ' + formatPnl(unrealizedPnl);
                unrealizedEl.style.color = unrealizedPnl >= 0 ? 'var(--positive)' : 'var(--negative)';
                
                document.getElementById('winRate').textContent = (data.win_rate ?? 0) + '%';
                document.getElementById('profitable').textContent = data.profitable ?? 0;
                document.getElementById('losing').textContent = data.losing ?? 0;
                document.getElementById('totalClosed').textContent = (data.total_closed ?? 0) + ' closed';
                
                // Signals
                document.getElementById('analyzed').textContent = (data.analyzed ?? 0).toLocaleString();
                document.getElementById('validSetups').textContent = (data.valid_setups ?? 0).toLocaleString();
                document.getElementById('accepted').textContent = (data.accepted ?? 0).toLocaleString();
                document.getElementById('rejected').textContent = (data.rejected ?? 0).toLocaleString();
                document.getElementById('bybitOpened').textContent = (data.bybit_opened ?? 0).toLocaleString();
                
                const analyzed = data.analyzed ?? 0;
                const validSetups = data.valid_setups ?? 0;
                const rejected = data.rejected ?? 0;
                document.getElementById('validSetupsPct').textContent = analyzed > 0 ? `${((validSetups / analyzed) * 100).toFixed(1)}% conversion` : '-';
                document.getElementById('rejectedPct').textContent = analyzed > 0 ? `${((rejected / analyzed) * 100).toFixed(1)}% filtered` : '-';
                
                const pnl = parseFloat(data.total_pnl || 0);
                const pnlEl = document.getElementById('totalPnl');
                pnlEl.textContent = formatPnl(pnl);
                pnlEl.className = 'stat-value ' + (pnl >= 0 ? 'positive' : 'negative');
                
                const winRateEl = document.getElementById('winRate');
                winRateEl.className = 'stat-value ' + ((data.win_rate ?? 0) >= 50 ? 'positive' : (data.win_rate ?? 0) > 0 ? 'negative' : '');
                
                renderReasons(data.win_reasons || {}, 'winReasons', true);
                renderReasons(data.loss_reasons || {}, 'lossReasons', false);
                
                document.getElementById('lastUpdate').textContent = formatTime24(new Date());
            } catch (error) {
                console.error('Error fetching stats:', error);
            }
        }
        
        async function fetchExtended() {
            try {
                const response = await fetch('/api/extended');
                const data = await response.json();
                currentExtended = data;
                
                const todayPnl = parseFloat(data.today_pnl || 0);
                const todayEl = document.getElementById('todayPnl');
                todayEl.textContent = formatPnl(todayPnl);
                todayEl.className = 'stat-value ' + (todayPnl >= 0 ? 'positive' : 'negative');
                document.getElementById('todayTrades').textContent = `${data.today_wins || 0}/${data.today_trades || 0} wins`;
                
                // Header
                const headerTodayEl = document.getElementById('headerTodayPnl');
                headerTodayEl.textContent = formatPnl(todayPnl);
                headerTodayEl.className = 'quick-stat-value ' + (todayPnl >= 0 ? 'positive' : 'negative');
                
                // Today PnL delta vs yesterday
                const yesterdayPnl = parseFloat(data.yesterday_pnl || 0);
                const todayDeltaEl = document.getElementById('headerTodayPnlDelta');
                if (yesterdayPnl !== 0) {
                    const pnlChange = todayPnl - yesterdayPnl;
                    const pnlChangePct = ((pnlChange / Math.abs(yesterdayPnl)) * 100).toFixed(0);
                    const sign = pnlChange >= 0 ? '+' : '';
                    todayDeltaEl.textContent = `vs yest: ${sign}${pnlChangePct}%`;
                    todayDeltaEl.className = 'quick-stat-delta ' + (pnlChange >= 0 ? 'up' : 'down');
                } else {
                    todayDeltaEl.textContent = '';
                }
                
                // Win Rate delta: today's WR vs all-time WR
                const todayTrades = data.today_trades || 0;
                const todayWins = data.today_wins || 0;
                const todayWR = todayTrades > 0 ? (todayWins / todayTrades * 100) : 0;
                const allTimeWR = currentStats?.win_rate || 0;
                const wrDeltaEl = document.getElementById('headerWinRateDelta');
                if (todayTrades > 0) {
                    const wrDiff = todayWR - allTimeWR;
                    const wrSign = wrDiff >= 0 ? '+' : '';
                    wrDeltaEl.textContent = `today: ${todayWR.toFixed(0)}% (${wrSign}${wrDiff.toFixed(0)}%)`;
                    wrDeltaEl.className = 'quick-stat-delta ' + (wrDiff >= 0 ? 'up' : 'down');
                } else {
                    wrDeltaEl.textContent = 'today: no trades';
                    wrDeltaEl.className = 'quick-stat-delta neutral';
                }
                
                document.getElementById('avgWin').textContent = '+$' + (data.avg_win || 0).toFixed(2);
                document.getElementById('avgLoss').textContent = '-$' + Math.abs(data.avg_loss || 0).toFixed(2);
                
                if (data.best_trade) {
                    document.getElementById('bestTrade').textContent = formatPnl(data.best_trade.pnl);
                    document.getElementById('bestTradeInfo').textContent = `${data.best_trade.symbol?.split('/')[0] || '-'} ${data.best_trade.direction || ''}`;
                }
                if (data.worst_trade) {
                    document.getElementById('worstTrade').textContent = formatPnl(data.worst_trade.pnl);
                    document.getElementById('worstTradeInfo').textContent = `${data.worst_trade.symbol?.split('/')[0] || '-'} ${data.worst_trade.direction || ''}`;
                }
                
                const streakEl = document.getElementById('streak');
                if (data.current_streak && data.streak_type) {
                    const streakClass = data.streak_type === 'win' ? 'streak-win' : 'streak-loss';
                    const streakIcon = data.streak_type === 'win' ? 'üî•' : '‚ùÑÔ∏è';
                    streakEl.innerHTML = `<span class="streak-badge ${streakClass}">${streakIcon} ${data.current_streak}</span>`;
                } else {
                    streakEl.textContent = '-';
                }
                
                document.getElementById('totalVolume').textContent = '$' + (data.total_volume || 0).toLocaleString();
                
                // Profit Factor
                const pf = data.profit_factor || 0;
                const pfEl = document.getElementById('profitFactor');
                pfEl.textContent = pf.toFixed(2);
                pfEl.className = 'stat-value sm ' + (pf >= 1.5 ? 'positive' : pf >= 1.0 ? '' : 'negative');
            } catch (error) {
                console.error('Error fetching extended:', error);
            }
        }
        
        async function fetchTrades() {
            try {
                const response = await fetch('/api/trades');
                const data = await response.json();
                renderTrades(data.trades);
            } catch (error) {
                console.error('Error fetching trades:', error);
            }
        }
        
        async function fetchLogs() {
            try {
                const response = await fetch('/api/logs?limit=150');
                const data = await response.json();
                allLogs = data.memory_logs || [];
                renderLogs(allLogs);
                document.getElementById('logsCount').textContent = (data.total_logs_in_buffer || 0).toLocaleString() + ' logs';
            } catch (error) {
                console.error('Error fetching logs:', error);
            }
        }
        
        async function fetchWinrateBreakdown() {
            try {
                const response = await fetch('/api/winrate_breakdown');
                const data = await response.json();
                if (data.thresholds) {
                    const t = data.thresholds;
                    ['60', '70', '80', '90', '95'].forEach(k => {
                        const wr = t[k] || {users: 0, trades: 0};
                        document.getElementById('wr' + k).textContent = (wr.users || 0) + ' users';
                        document.getElementById('wr' + k + 'trades').textContent = (wr.trades || 0) + ' trades';
                    });
                }
            } catch (error) {
                console.error('Error fetching winrate breakdown:', error);
            }
        }
        
        async function fetchAlerts() {
            try {
                const response = await fetch('/api/alerts?hours=6&limit=50');
                const data = await response.json();
                const section = document.getElementById('alertsSection');
                const counts = data.counts || {};
                
                if (counts.total > 0) {
                    section.style.display = 'block';
                    
                    ['critical', 'error', 'warning'].forEach(level => {
                        const el = document.getElementById(level + 'Count');
                        if (counts[level] > 0) {
                            el.textContent = counts[level] + ' ' + level.toUpperCase();
                            el.style.display = 'inline-block';
                        } else {
                            el.style.display = 'none';
                        }
                    });
                    
                    const patternsEl = document.getElementById('alertPatterns');
                    let pHtml = '';
                    for (const p of (data.top_patterns || []).slice(0, 5)) {
                        const cls = p.level === 'WARNING' ? 'warning' : '';
                        pHtml += `<span class="alert-pattern ${cls}">
                            <span class="alert-pattern-count">${p.count}√ó</span>
                            <span>${escapeHtml(p.pattern)}</span>
                        </span>`;
                    }
                    patternsEl.innerHTML = pHtml;
                    
                    const container = document.getElementById('alertsContainer');
                    if (data.alerts && data.alerts.length > 0) {
                        let html = '';
                        for (const alert of data.alerts.slice(0, 30)) {
                            html += `<div class="log-entry">
                                <span class="log-time">${alert.timestamp || '-'}</span>
                                <span class="log-level ${alert.level}">${alert.level}</span>
                                <span class="log-message">${escapeHtml(alert.message || '-')}</span>
                            </div>`;
                        }
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = '<div class="no-data">No alerts in the last 6 hours</div>';
                    }
                } else {
                    section.style.display = 'none';
                }
            } catch (error) {
                console.error('Error fetching alerts:', error);
            }
        }
        
        async function fetchPositions() {
            try {
                const response = await fetch('/api/positions');
                const data = await response.json();
                renderLivePositions(data.positions || []);
            } catch (error) {
                console.error('Error fetching positions:', error);
            }
        }
        
        async function fetchNews() {
            try {
                const response = await fetch('/api/news');
                const data = await response.json();
                renderNews(data.news || []);
                if (data.bob_index) updateBOB(data.bob_index);
                else updateSentiment(data.sentiment || {});
            } catch (error) {
                console.error('Error fetching news:', error);
                document.getElementById('newsList').innerHTML = '<div class="no-data">‚ùå Error loading news</div>';
            }
        }
        
        async function fetchUsers() {
            try {
                const response = await fetch('/api/users');
                const data = await response.json();
                allUsers = data.users || [];
                
                document.getElementById('totalUsers').textContent = data.count || 0;
                
                // Total Equity = Balance + Positions Value
                const totalBalance = data.totals?.total_balance || 0;
                const totalPositions = data.totals?.total_positions_value || 0;
                const totalEquity = data.totals?.total_equity || (totalBalance + totalPositions);
                const totalPnl = data.totals?.total_pnl || 0;
                
                document.getElementById('usersEquity').textContent = '$' + totalEquity.toLocaleString(undefined, {maximumFractionDigits: 2});
                document.getElementById('usersEquitySub').textContent = `($${totalBalance.toLocaleString()} bal + $${totalPositions.toLocaleString()} pos)`;
                document.getElementById('usersDeposits').textContent = '$' + (data.totals?.total_deposits || 0).toLocaleString();
                
                const pnlEl = document.getElementById('usersTotalPnl');
                pnlEl.textContent = (totalPnl >= 0 ? '+' : '') + '$' + totalPnl.toLocaleString(undefined, {maximumFractionDigits: 2});
                pnlEl.className = 'summary-value ' + (totalPnl >= 0 ? 'positive' : 'negative');
                
                document.getElementById('activeTraders').textContent = data.totals?.active_traders || 0;
                document.getElementById('autoTraders').textContent = data.totals?.auto_traders || 0;
                
                renderUsers();
            } catch (error) {
                console.error('Error fetching users:', error);
            }
        }
        
        function sortUsers(field) {
            document.querySelectorAll('.data-table th').forEach(th => th.classList.remove('sorted-asc', 'sorted-desc'));
            if (usersSortField === field) {
                usersSortDir = usersSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                usersSortField = field;
                usersSortDir = 'desc';
            }
            renderUsers();
        }
        
        function filterUsers() {
            renderUsers();
        }
        
        function renderUsers() {
            const tbody = document.getElementById('usersBody');
            const searchTerm = document.getElementById('userSearch')?.value || '';
            
            let filteredUsers = allUsers;
            if (searchTerm) {
                filteredUsers = allUsers.filter(u => u.user_id.toString().includes(searchTerm));
            }
            
            if (!filteredUsers || filteredUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="no-data">No users found</td></tr>';
                return;
            }
            
            const sorted = [...filteredUsers].sort((a, b) => {
                let aVal = a[usersSortField];
                let bVal = b[usersSortField];
                if (typeof aVal === 'boolean') aVal = aVal ? 1 : 0;
                if (typeof bVal === 'boolean') bVal = bVal ? 1 : 0;
                return usersSortDir === 'asc' ? (aVal > bVal ? 1 : -1) : (aVal < bVal ? 1 : -1);
            });
            
            let html = '';
            for (const user of sorted.slice(0, 100)) {
                const pnlClass = user.total_pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
                const tradingBadge = user.trading ? '<span class="badge badge-on">ON</span>' : '<span class="badge badge-off">OFF</span>';
                const autoBadge = user.auto_trade ? '<span class="badge badge-auto">ON</span>' : '<span class="badge badge-off">OFF</span>';
                
                html += `<tr onclick="document.getElementById('userIdInput').value='${user.user_id}'; switchTab('analytics'); lookupUser();" style="cursor: pointer;">
                    <td><code style="color: var(--accent);">${user.user_id}</code></td>
                    <td style="font-family: 'JetBrains Mono', monospace;">$${user.balance.toFixed(2)}</td>
                    <td style="font-family: 'JetBrains Mono', monospace;">$${user.total_deposit.toFixed(2)}</td>
                    <td>${user.total_trades}</td>
                    <td>${user.wins}/${user.total_trades - user.wins}</td>
                    <td>${user.winrate}%</td>
                    <td class="${pnlClass}">${formatPnl(user.total_pnl)}</td>
                    <td>${user.open_positions}</td>
                    <td>${tradingBadge}</td>
                    <td>${autoBadge}</td>
                </tr>`;
            }
            tbody.innerHTML = html;
        }
        
        // ==================== AI BRAIN ====================
        let aiData = null;
        
        async function fetchAI() {
            try {
                const response = await fetch('/api/ai');
                aiData = await response.json();
                renderAI();
            } catch (error) {
                console.error('Error fetching AI data:', error);
                document.getElementById('aiStatus').innerHTML = '<span style="color: var(--negative);">‚ùå Error</span>';
            }
        }
        
        function renderAI() {
            if (!aiData) return;
            
            // Status & Stats
            if (aiData.available) {
                const statusText = aiData.initialized ? '‚úÖ Active' : '‚è≥ Initializing...';
                document.getElementById('aiStatus').innerHTML = `<span style="color: ${aiData.initialized ? 'var(--positive)' : 'var(--warning)'}">${statusText}</span>`;
            } else {
                document.getElementById('aiStatus').innerHTML = '<span style="color: var(--negative);">‚ùå Not Available</span>';
                return;
            }
            
            const stats = aiData.stats || {};
            document.getElementById('aiTradesAnalyzed').textContent = stats.total_trades_analyzed || 0;
            document.getElementById('aiNewsAnalyzed').textContent = stats.total_news_analyzed || 0;
            document.getElementById('aiNewsTracking').textContent = stats.news_tracking_count || 0;
            document.getElementById('aiLearnedRules').textContent = stats.learned_rules_count || 0;
            document.getElementById('aiTradePatterns').textContent = stats.trade_patterns_count || 0;
            document.getElementById('aiAccuracy').textContent = (stats.prediction_accuracy || 0) + '%';
            
            // Recent Analyses
            renderAIAnalyses(aiData.recent_analyses || []);
            
            // Learned Rules
            renderAIRules(aiData.learned_rules || []);
            
            // Symbol Patterns
            renderAISymbolPatterns(aiData.pattern_summary || {});
            
            // News Patterns
            renderAINewsPatterns(aiData.news_patterns || []);
            
            // Pending News Tracking
            renderAIPendingNews(aiData.pending_news || []);
            
            // News tracking count
            if (aiData.stats?.news_tracking_count) {
                document.getElementById('aiPendingNewsCount').textContent = aiData.stats.news_tracking_count + ' tracking';
            }
            
            // Insights
            renderAIInsights(aiData.insights || []);
            
            // Market Analysis (win/loss factors on Overview tab)
            renderMarketFactors(aiData.win_factors || {}, 'winFactors', true);
            renderMarketFactors(aiData.loss_factors || {}, 'lossFactors', false);
        }
        
        function renderAIAnalyses(analyses) {
            const container = document.getElementById('aiAnalysesList');
            const totalCount = aiData?.total_analyses_count || analyses.length;
            document.getElementById('aiAnalysesCount').textContent = totalCount > analyses.length 
                ? `last ${analyses.length} of ${totalCount}` 
                : analyses.length;
            
            if (!analyses || analyses.length === 0) {
                container.innerHTML = '<div class="no-data">No trade analyses yet. AI will analyze each closed trade.</div>';
                return;
            }
            
            let html = '';
            for (const a of analyses) {
                const isWin = a.is_win;
                const pnlClass = isWin ? 'pnl-positive' : 'pnl-negative';
                const icon = isWin ? '‚úÖ' : '‚ùå';
                const timeStr = a.timestamp ? formatTimeAgo(a.timestamp) : '';
                
                // Compact card
                html += `<div style="padding: 10px 12px; background: var(--bg-card); border-radius: 8px; margin-bottom: 6px; border-left: 3px solid ${isWin ? 'var(--positive)' : 'var(--negative)'};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                        <span style="font-weight: 600; color: var(--accent); font-size: 0.85rem;">${icon} ${a.symbol} <span style="font-weight:400;color:var(--text-muted);font-size:0.72rem;">${a.direction}</span></span>
                        <span class="${pnlClass}" style="font-family: 'JetBrains Mono', monospace; font-size: 0.85rem;">${formatPnl(a.pnl)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.72rem; color: var(--text-muted); margin-bottom: 4px;">
                        <span>$${a.entry_price?.toFixed(4) || '?'} ‚Üí $${a.exit_price?.toFixed(4) || '?'}</span>
                        <span>${timeStr}</span>
                    </div>
                    <div style="display: flex; gap: 6px; margin-bottom: 4px;">
                        <span class="badge" style="background: var(--accent-bg); color: var(--accent); font-size: 0.65rem;">Entry: ${a.entry_quality}/10</span>
                        <span class="badge" style="background: var(--accent-bg); color: var(--accent); font-size: 0.65rem;">Exit: ${a.exit_quality}/10</span>
                    </div>`;
                
                if (a.lessons_learned && a.lessons_learned.length > 0) {
                    html += `<div style="font-size: 0.72rem; margin-top: 4px; color: var(--text-secondary);">
                        <strong style="color: var(--warning);">üìö</strong> ${escapeHtml(a.lessons_learned[0])}
                    </div>`;
                }
                
                html += '</div>';
            }
            container.innerHTML = html;
        }
        
        function renderAIRules(rules) {
            const container = document.getElementById('aiRulesList');
            const totalCount = aiData?.total_rules_count || rules.length;
            document.getElementById('aiRulesCount').textContent = totalCount > rules.length 
                ? `last ${rules.length} of ${totalCount}` 
                : rules.length;
            
            if (!rules || rules.length === 0) {
                container.innerHTML = '<div class="no-data">AI is learning rules from each trade. Rules will appear here.</div>';
                return;
            }
            
            let html = '';
            for (let i = 0; i < rules.length; i++) {
                const rule = rules[i];
                const isNewsRule = rule.startsWith('[NEWS]');
                const icon = isNewsRule ? 'üì∞' : 'üìä';
                const bgColor = isNewsRule ? 'rgba(168, 85, 247, 0.06)' : 'var(--bg-card)';
                const borderColor = isNewsRule ? 'var(--purple)' : 'var(--accent)';
                
                // Truncate long rules to 150 chars for readability
                let ruleText = rule.replace('[NEWS] ', '');
                const isTruncated = ruleText.length > 150;
                const shortText = isTruncated ? ruleText.slice(0, 150) + '...' : ruleText;
                
                html += `<div style="padding: 8px 10px; background: ${bgColor}; border-radius: 6px; margin-bottom: 4px; border-left: 2px solid ${borderColor}; font-size: 0.78rem; line-height: 1.4; cursor: ${isTruncated ? 'pointer' : 'default'};" ${isTruncated ? `onclick="this.querySelector('.rule-full').style.display = this.querySelector('.rule-full').style.display === 'none' ? 'block' : 'none'; this.querySelector('.rule-short').style.display = this.querySelector('.rule-short').style.display === 'none' ? 'block' : 'none';"` : ''}>
                    <span style="margin-right: 4px;">${icon}</span>
                    <span class="rule-short" style="color: var(--text-primary);">${escapeHtml(shortText)}</span>
                    ${isTruncated ? `<span class="rule-full" style="color: var(--text-primary); display: none;">${escapeHtml(ruleText)}</span>` : ''}
                </div>`;
            }
            container.innerHTML = html;
        }
        
        function renderAISymbolPatterns(patterns) {
            const container = document.getElementById('aiSymbolPatterns');
            const symbols = Object.keys(patterns);
            
            if (!symbols || symbols.length === 0) {
                container.innerHTML = '<div class="no-data">AI is building knowledge about each symbol.</div>';
                return;
            }
            
            // Sort by total trades
            symbols.sort((a, b) => (patterns[b].total || 0) - (patterns[a].total || 0));
            
            let html = '';
            for (const symbol of symbols.slice(0, 15)) {
                const p = patterns[symbol];
                const winrate = p.winrate || 0;
                const wrColor = winrate >= 60 ? 'var(--positive)' : winrate >= 40 ? 'var(--warning)' : 'var(--negative)';
                
                html += `<div style="padding: 10px 12px; background: var(--bg-card); border-radius: 8px; margin-bottom: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                        <span style="font-weight: 600; color: var(--accent);">${symbol}</span>
                        <span style="font-family: 'JetBrains Mono', monospace; color: ${wrColor}; font-weight: 600;">${winrate}% WR</span>
                    </div>
                    <div style="display: flex; gap: 12px; font-size: 0.8rem; margin-bottom: 6px;">
                        <span style="color: var(--positive);">‚úÖ ${p.wins} wins</span>
                        <span style="color: var(--negative);">‚ùå ${p.losses} losses</span>
                        <span style="color: var(--text-muted);">üìä ${p.total} total</span>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); border-radius: 4px; height: 6px; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, var(--positive), var(--accent)); height: 100%; width: ${winrate}%;"></div>
                    </div>`;
                
                if (p.recent_lessons && p.recent_lessons.length > 0) {
                    html += `<div style="font-size: 0.7rem; margin-top: 6px; color: var(--text-secondary);">
                        üí° ${p.recent_lessons.slice(0, 2).map(l => escapeHtml(l)).join(' | ')}
                    </div>`;
                }
                
                html += '</div>';
            }
            container.innerHTML = html;
        }
        
        function renderAINewsPatterns(patterns) {
            const container = document.getElementById('aiNewsPatterns');
            
            if (!patterns || patterns.length === 0) {
                container.innerHTML = '<div class="no-data">AI is learning how news affects the market.</div>';
                return;
            }
            
            let html = '';
            for (const p of patterns) {
                const dirIcon = p.direction === 'BULLISH' ? 'üìà' : p.direction === 'BEARISH' ? 'üìâ' : '‚û°Ô∏è';
                const dirColor = p.direction === 'BULLISH' ? 'var(--positive)' : p.direction === 'BEARISH' ? 'var(--negative)' : 'var(--text-secondary)';
                const changeColor = p.change >= 0 ? 'var(--positive)' : 'var(--negative)';
                
                html += `<div style="padding: 10px 12px; background: var(--bg-card); border-radius: 8px; margin-bottom: 8px; border-left: 3px solid ${dirColor};">
                    <div style="font-size: 0.85rem; color: var(--text-primary); margin-bottom: 6px;">
                        ${escapeHtml(p.title || 'Unknown news')}
                    </div>
                    <div style="display: flex; gap: 12px; font-size: 0.75rem; align-items: center;">
                        <span style="color: ${dirColor};">${dirIcon} ${p.direction}</span>
                        <span style="color: ${changeColor}; font-family: 'JetBrains Mono', monospace;">${p.change >= 0 ? '+' : ''}${p.change}%</span>
                        <span class="badge" style="font-size: 0.65rem;">${p.category || 'other'}</span>
                    </div>`;
                
                if (p.patterns && p.patterns.length > 0) {
                    html += `<div style="font-size: 0.7rem; margin-top: 6px; color: var(--warning);">
                        üîç ${p.patterns.slice(0, 2).map(pt => escapeHtml(pt)).join(', ')}
                    </div>`;
                }
                
                html += '</div>';
            }
            container.innerHTML = html;
        }
        
        function renderAIPendingNews(pending) {
            const container = document.getElementById('aiPendingNews');
            document.getElementById('aiPendingNewsCount').textContent = pending.length + ' pending';
            
            if (!pending || pending.length === 0) {
                container.innerHTML = '<div class="no-data">No news currently being tracked. RSS news will appear here when AI starts monitoring them.</div>';
                return;
            }
            
            let html = '';
            for (const news of pending) {
                const coinsStr = news.coins?.join(', ') || 'BTC';
                
                html += `<div style="padding: 10px 12px; background: rgba(255, 165, 2, 0.1); border-radius: 8px; margin-bottom: 6px; border-left: 3px solid var(--warning);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px;">
                        <span style="font-size: 0.85rem; color: var(--text-primary); flex: 1;">${escapeHtml(news.title || 'Unknown')}</span>
                        <span style="font-size: 0.65rem; color: var(--text-muted); margin-left: 8px; white-space: nowrap;">${formatTimeAgo(news.timestamp)}</span>
                    </div>
                    <div style="display: flex; gap: 8px; font-size: 0.7rem; align-items: center;">
                        <span style="color: var(--info);">üì∞ ${news.source || 'RSS'}</span>
                        <span style="color: var(--accent);">üìä ${coinsStr}</span>
                        <span class="badge" style="font-size: 0.6rem; background: var(--warning); color: #000;">‚è≥ Tracking</span>
                    </div>
                </div>`;
            }
            container.innerHTML = html;
        }
        
        let _insightExpandState = {};
        
        function toggleInsight(id) {
            const preview = document.getElementById('insight-preview-' + id);
            const full = document.getElementById('insight-full-' + id);
            const btn = document.getElementById('insight-btn-' + id);
            if (full.style.display === 'none') {
                full.style.display = 'block';
                preview.style.display = 'none';
                btn.textContent = '‚ñ≤ Collapse';
                _insightExpandState[id] = true;
            } else {
                full.style.display = 'none';
                preview.style.display = 'block';
                btn.textContent = '‚ñº Expand';
                _insightExpandState[id] = false;
            }
        }
        
        function renderAIInsights(insights) {
            const container = document.getElementById('aiInsightsList');
            document.getElementById('aiInsightsCount').textContent = insights.length;
            
            if (!insights || insights.length === 0) {
                container.innerHTML = '<div class="no-data">No reports yet. Click "Generate Yesterday" to create a daily summary.</div>';
                return;
            }
            
            let html = '';
            for (let idx = 0; idx < insights.length; idx++) {
                const insight = insights[idx];
                const isDailySummary = insight.category === 'daily_summary';
                const categoryIcon = isDailySummary ? 'üìÖ' : insight.category === 'trade' ? 'üìä' : 'üí°';
                
                // Use title if available (PnL-based), otherwise fallback
                let displayTitle = '';
                if (insight.title) {
                    displayTitle = insight.title;
                } else if (isDailySummary) {
                    const pnlMatch = (insight.insight || '').match(/PnL[:\s]*([+-]?\$[\d,.]+)/i);
                    displayTitle = pnlMatch ? `Daily Report ${pnlMatch[1]}` : 'Daily Report';
                } else {
                    displayTitle = insight.category === 'trade' ? 'Trade Analysis' : 'Insight';
                }
                
                // Show full date/time
                let dateStr = '';
                if (insight.timestamp) {
                    try {
                        const d = new Date(insight.timestamp);
                        dateStr = d.toLocaleDateString('ru-RU', {day:'2-digit', month:'2-digit', year:'numeric'}) + ' ' + d.toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'});
                    } catch(e) {
                        dateStr = formatTimeAgo(insight.timestamp);
                    }
                }
                const timeAgo = formatTimeAgo(insight.timestamp);
                
                // Color the title based on PnL sign
                const titleColor = isDailySummary 
                    ? (insight.title && insight.title.startsWith('-') ? 'var(--negative)' : 'var(--positive)')
                    : 'var(--accent)';
                
                // Render content with markdown
                const fullContent = renderMarkdown(insight.insight || '');
                const rawText = insight.insight || '';
                
                // Preview: first 200 chars, plain text
                const previewLen = 200;
                const needsExpand = rawText.length > previewLen;
                const previewText = needsExpand ? rawText.slice(0, previewLen).replace(/\n/g, ' ') + '...' : '';
                
                const isExpanded = _insightExpandState[idx] || false;
                
                html += `<div style="padding: 14px; background: var(--bg-card); border-radius: 10px; margin-bottom: 10px; border-left: 3px solid ${isDailySummary ? titleColor : 'var(--border-color)'};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: 600; color: ${titleColor}; font-size: 0.9rem;">${categoryIcon} ${escapeHtml(displayTitle)}</span>
                        <span style="font-size: 0.72rem; color: var(--text-muted);">üìÖ ${dateStr} &nbsp;(${timeAgo})</span>
                    </div>`;
                
                if (needsExpand) {
                    html += `
                    <div id="insight-preview-${idx}" style="font-size: 0.8rem; color: var(--text-muted); line-height: 1.4; display: ${isExpanded ? 'none' : 'block'};">
                        ${escapeHtml(previewText)}
                    </div>
                    <div id="insight-full-${idx}" style="font-size: 0.82rem; color: var(--text-secondary); line-height: 1.6; display: ${isExpanded ? 'block' : 'none'};">
                        ${fullContent}
                    </div>
                    <button id="insight-btn-${idx}" onclick="toggleInsight(${idx})" style="background:none;border:none;color:var(--accent);cursor:pointer;font-size:0.75rem;padding:6px 0 0;font-family:inherit;">
                        ${isExpanded ? '‚ñ≤ Collapse' : '‚ñº Expand'}
                    </button>`;
                } else {
                    html += `
                    <div style="font-size: 0.82rem; color: var(--text-secondary); line-height: 1.6;">
                        ${fullContent}
                    </div>`;
                }
                
                html += '</div>';
            }
            container.innerHTML = html;
        }
        
        let _genReportIdx = 9000; // unique IDs for newly generated reports
        
        async function generateReport(period) {
            const btn = document.getElementById('btnGenReport');
            const origText = btn.textContent;
            btn.textContent = 'Generating...';
            btn.disabled = true;
            try {
                const resp = await fetch('/api/ai/generate_report', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({date: period})
                });
                const data = await resp.json();
                if (data.success) {
                    const container = document.getElementById('aiInsightsList');
                    const dateLabel = data.date || period;
                    const genAt = data.generated_at || new Date().toLocaleString('ru-RU');
                    const reportTitle = data.title || `Report ${dateLabel}`;
                    const pnl = data.total_pnl || 0;
                    const pnlColor = pnl >= 0 ? 'var(--positive)' : 'var(--negative)';
                    const rawReport = data.report || 'Empty report';
                    const fullContent = renderMarkdown(rawReport);
                    const idx = _genReportIdx++;
                    const needsExpand = rawReport.length > 200;
                    const previewText = needsExpand ? rawReport.slice(0, 200).replace(/\n/g, ' ') + '...' : '';
                    
                    let newHtml = `<div style="padding: 14px; background: var(--bg-card); border-radius: 10px; margin-bottom: 10px; border-left: 3px solid ${pnlColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: 600; color: ${pnlColor}; font-size: 0.9rem;">üìÖ ${escapeHtml(reportTitle)}</span>
                            <span style="font-size: 0.72rem; color: var(--text-muted);">üìÖ ${escapeHtml(dateLabel)} &nbsp;|&nbsp; ${escapeHtml(genAt)}</span>
                        </div>`;
                    
                    if (needsExpand) {
                        newHtml += `
                        <div id="insight-preview-${idx}" style="font-size: 0.8rem; color: var(--text-muted); line-height: 1.4; display: none;">
                            ${escapeHtml(previewText)}
                        </div>
                        <div id="insight-full-${idx}" style="font-size: 0.82rem; color: var(--text-secondary); line-height: 1.6; display: block;">
                            ${fullContent}
                        </div>
                        <button id="insight-btn-${idx}" onclick="toggleInsight(${idx})" style="background:none;border:none;color:var(--accent);cursor:pointer;font-size:0.75rem;padding:6px 0 0;font-family:inherit;">
                            ‚ñ≤ Collapse
                        </button>`;
                    } else {
                        newHtml += `
                        <div style="font-size: 0.82rem; color: var(--text-secondary); line-height: 1.6;">
                            ${fullContent}
                        </div>`;
                    }
                    newHtml += '</div>';
                    
                    const existingContent = container.querySelector('.no-data') ? '' : container.innerHTML;
                    container.innerHTML = newHtml + existingContent;
                    _insightExpandState[idx] = true;
                } else {
                    alert('Error: ' + (data.error || 'Unknown'));
                }
            } catch(e) {
                alert('Failed to generate report: ' + e);
            } finally {
                btn.textContent = origText;
                btn.disabled = false;
            }
        }
        
        function switchKnowledgeTab(tab, btn) {
            document.getElementById('knowledgeSymbols').style.display = tab === 'symbols' ? '' : 'none';
            document.getElementById('knowledgeNews').style.display = tab === 'news' ? '' : 'none';
            // Toggle active class
            btn.parentElement.querySelectorAll('.log-tab').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        
        // PnL Chart - –∑–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        async function initPnlChart() {
            const ctx = document.getElementById('pnlChart');
            if (!ctx) return;
            
            if (pnlChart) {
                pnlChart.destroy();
            }
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ API
                const response = await fetch('/api/pnl_history');
                const result = await response.json();
                
                if (result.error || !result.data || result.data.length === 0) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
                    ctx.parentElement.innerHTML = '<div class="no-data" style="padding: 40px;">No trade history yet</div>';
                    return;
                }
                
                const labels = result.data.map(d => {
                    const date = new Date(d.date);
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                });
                const dailyPnl = result.data.map(d => d.daily_pnl);
                const cumulativePnl = result.data.map(d => d.cumulative_pnl);
                const winrates = result.data.map(d => d.winrate);
                
                pnlChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Cumulative PnL',
                                data: cumulativePnl,
                                borderColor: '#00ff88',
                                backgroundColor: 'rgba(0, 255, 136, 0.1)',
                                fill: true,
                                tension: 0.4,
                                pointRadius: 3,
                                pointBackgroundColor: '#00ff88',
                                yAxisID: 'y'
                            },
                            {
                                label: 'Daily PnL',
                                data: dailyPnl,
                                borderColor: '#4a9eff',
                                backgroundColor: 'transparent',
                                borderDash: [5, 5],
                                tension: 0.4,
                                pointRadius: 2,
                                yAxisID: 'y'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: { 
                                display: true,
                                labels: { color: 'rgba(232, 240, 240, 0.6)', font: { size: 10 } }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const idx = context.dataIndex;
                                        const item = result.data[idx];
                                        if (context.datasetIndex === 0) {
                                            return `Cumulative: $${item.cumulative_pnl.toFixed(2)}`;
                                        } else {
                                            return `Daily: $${item.daily_pnl.toFixed(2)} (${item.trades} trades, ${item.winrate}% WR)`;
                                        }
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { color: 'rgba(255, 255, 255, 0.03)' },
                                ticks: { color: 'rgba(232, 240, 240, 0.4)', maxRotation: 45 }
                            },
                            y: {
                                grid: { color: 'rgba(255, 255, 255, 0.03)' },
                                ticks: { 
                                    color: 'rgba(232, 240, 240, 0.4)',
                                    callback: v => '$' + v.toFixed(0)
                                }
                            }
                        }
                    }
                });
                
                // –¢–∞–∫–∂–µ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–≤–æ–¥–Ω—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É
                fetchAnalyticsSummary();
                
            } catch (error) {
                console.error('Error loading PnL chart:', error);
                ctx.parentElement.innerHTML = '<div class="no-data" style="padding: 40px;">Error loading chart data</div>';
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–≤–æ–¥–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
        async function fetchAnalyticsSummary() {
            try {
                const response = await fetch('/api/analytics_summary');
                const data = await response.json();
                
                if (data.error) return;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º summary –∫–∞—Ä—Ç–æ—á–∫–∏ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                const summaryContainer = document.getElementById('analyticsSummary');
                if (summaryContainer && data) {
                    let html = '';
                    
                    // Last 24h stats
                    if (data.last_24h) {
                        html += `<div class="stat-card">
                            <div class="stat-label">Last 24h</div>
                            <div class="stat-value sm ${data.last_24h.pnl >= 0 ? 'positive' : 'negative'}">
                                ${data.last_24h.pnl >= 0 ? '+' : ''}$${data.last_24h.pnl.toFixed(2)}
                            </div>
                            <div class="stat-sub">${data.last_24h.trades} trades, ${data.last_24h.winrate}% WR</div>
                        </div>`;
                    }
                    
                    // Last 7d stats
                    if (data.last_7d) {
                        html += `<div class="stat-card">
                            <div class="stat-label">Last 7 Days</div>
                            <div class="stat-value sm ${data.last_7d.pnl >= 0 ? 'positive' : 'negative'}">
                                ${data.last_7d.pnl >= 0 ? '+' : ''}$${data.last_7d.pnl.toFixed(2)}
                            </div>
                            <div class="stat-sub">${data.last_7d.trades} trades, ${data.last_7d.winrate}% WR</div>
                        </div>`;
                    }
                    
                    // Direction performance
                    if (data.by_direction) {
                        const long = data.by_direction.LONG || { trades: 0, winrate: 0, pnl: 0 };
                        const short = data.by_direction.SHORT || { trades: 0, winrate: 0, pnl: 0 };
                        html += `<div class="stat-card">
                            <div class="stat-label">LONG Performance</div>
                            <div class="stat-value sm ${long.pnl >= 0 ? 'positive' : 'negative'}">
                                ${long.winrate}% WR
                            </div>
                            <div class="stat-sub">${long.trades} trades, ${long.pnl >= 0 ? '+' : ''}$${long.pnl.toFixed(2)}</div>
                        </div>`;
                        html += `<div class="stat-card">
                            <div class="stat-label">SHORT Performance</div>
                            <div class="stat-value sm ${short.pnl >= 0 ? 'positive' : 'negative'}">
                                ${short.winrate}% WR
                            </div>
                            <div class="stat-sub">${short.trades} trades, ${short.pnl >= 0 ? '+' : ''}$${short.pnl.toFixed(2)}</div>
                        </div>`;
                    }
                    
                    summaryContainer.innerHTML = html;
                }
                
                // Top symbols
                const topContainer = document.getElementById('topSymbols');
                if (topContainer && data.top_symbols) {
                    let html = '<div class="section-title" style="font-size: 0.75rem;"><span class="section-icon">üèÜ</span> Top Performing Symbols (30d)</div>';
                    html += '<div style="display: flex; flex-wrap: wrap; gap: 8px;">';
                    for (const sym of data.top_symbols.slice(0, 5)) {
                        html += `<div class="badge" style="padding: 6px 10px; background: rgba(0, 255, 136, 0.1); border: 1px solid rgba(0, 255, 136, 0.3);">
                            <strong>${sym.symbol.replace('/USDT', '')}</strong>: +$${sym.pnl.toFixed(2)} (${sym.winrate}% WR, ${sym.trades} trades)
                        </div>`;
                    }
                    html += '</div>';
                    topContainer.innerHTML = html;
                }
                
                // Worst symbols
                const worstContainer = document.getElementById('worstSymbols');
                if (worstContainer && data.worst_symbols) {
                    let html = '<div class="section-title" style="font-size: 0.75rem; margin-top: 12px;"><span class="section-icon">‚ö†Ô∏è</span> Worst Performing Symbols (30d)</div>';
                    html += '<div style="display: flex; flex-wrap: wrap; gap: 8px;">';
                    for (const sym of data.worst_symbols.slice(0, 5)) {
                        html += `<div class="badge" style="padding: 6px 10px; background: rgba(255, 92, 92, 0.1); border: 1px solid rgba(255, 92, 92, 0.3);">
                            <strong>${sym.symbol.replace('/USDT', '')}</strong>: $${sym.pnl.toFixed(2)} (${sym.winrate}% WR, ${sym.trades} trades)
                        </div>`;
                    }
                    html += '</div>';
                    worstContainer.innerHTML = html;
                }
                
            } catch (error) {
                console.error('Error fetching analytics summary:', error);
            }
        }
        
        // Learning Analytics
        async function fetchLearningData() {
            try {
                const response = await fetch('/api/learning');
                const result = await response.json();
                
                if (!result.success || result.data.status === 'no_data') {
                    document.getElementById('learningSection').innerHTML = '<div class="no-data">No learning data yet. Wait for trades to accumulate.</div>';
                    return;
                }
                
                const data = result.data;
                
                // Learning Score
                const scoreEl = document.getElementById('learningScore');
                scoreEl.textContent = data.learning.score + '/100';
                scoreEl.className = 'stat-value ' + (data.learning.score >= 70 ? 'positive' : data.learning.score >= 50 ? '' : 'negative');
                
                // Status
                const statusEl = document.getElementById('learningStatus');
                const statusEmoji = { 'improving': 'üìà', 'stable': '‚û°Ô∏è', 'degrading': 'üìâ' };
                statusEl.textContent = (statusEmoji[data.learning.status] || '‚ùì') + ' ' + (data.learning.status || 'unknown').toUpperCase();
                
                // Knowledge
                document.getElementById('rulesLearned').textContent = data.learning.rules_count || 0;
                document.getElementById('patternsFound').textContent = data.learning.patterns_count || 0;
                document.getElementById('aiAccuracy').textContent = (data.learning.prediction_accuracy || 50) + '%';
                
                // Trends
                const formatTrend = (val, suffix = '') => {
                    if (val > 0) return `<span class="positive">+${val.toFixed(1)}${suffix}</span>`;
                    if (val < 0) return `<span class="negative">${val.toFixed(1)}${suffix}</span>`;
                    return `<span>0${suffix}</span>`;
                };
                
                document.getElementById('winrateTrend').innerHTML = formatTrend(data.trends?.winrate || 0, '%');
                document.getElementById('pnlTrend').innerHTML = formatTrend(data.trends?.pnl || 0, '$');
                document.getElementById('accuracyTrend').innerHTML = formatTrend((data.trends?.accuracy || 0) * 100, '%');
                
                // Recommendations
                const recsContainer = document.getElementById('learningRecommendations');
                if (data.recommendations && data.recommendations.length > 0) {
                    recsContainer.innerHTML = data.recommendations.map(r => `<div style="margin-bottom: 4px;">‚Ä¢ ${r}</div>`).join('');
                } else {
                    recsContainer.innerHTML = '‚úÖ No specific recommendations';
                }
                
            } catch (error) {
                console.error('Error fetching learning data:', error);
                document.getElementById('learningSection').innerHTML = '<div class="no-data">Failed to load learning data</div>';
            }
        }
        
        // User Lookup
        async function lookupUser() {
            const userId = document.getElementById('userIdInput').value.trim().replace(/\s/g, '');
            if (!userId) { alert('Enter a User ID'); return; }
            
            try {
                const response = await fetch(`/api/user/${userId}`);
                const data = await response.json();
                if (data.error) { alert('Error: ' + data.error); return; }
                
                document.getElementById('userInfoContainer').style.display = 'block';
                
                const balance = parseFloat(data.balance || 0);
                const deposit = parseFloat(data.total_deposit || 0);
                const profit = parseFloat(data.total_profit || 0);
                
                document.getElementById('userBalance').textContent = '$' + balance.toFixed(2);
                document.getElementById('userDeposit').textContent = '$' + deposit.toFixed(2);
                
                const profitEl = document.getElementById('userProfit');
                profitEl.textContent = formatPnl(profit);
                profitEl.className = 'stat-value sm ' + (profit >= 0 ? 'positive' : 'negative');
                
                const openPosAmount = (data.open_positions || []).reduce((sum, p) => sum + (p.amount || 0), 0);
                const expected = deposit + profit;
                const actual = balance + openPosAmount;
                const missing = expected - actual;
                
                const missingEl = document.getElementById('userMissing');
                missingEl.textContent = '$' + missing.toFixed(2);
                missingEl.className = 'stat-value sm ' + (Math.abs(missing) > 0.1 ? 'negative' : 'positive');
                
                // Positions
                document.getElementById('userPosCount').textContent = data.open_positions_count || 0;
                const posContainer = document.getElementById('userPositions');
                if (data.open_positions && data.open_positions.length > 0) {
                    let html = '';
                    for (const pos of data.open_positions) {
                        const pnl = parseFloat(pos.pnl || 0);
                        const pnlClass = pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
                        html += `<div class="log-entry">
                            <span style="min-width: 80px; color: var(--info);">${pos.symbol?.split('/')[0] || '-'}</span>
                            <span style="min-width: 60px;" class="badge ${pos.direction === 'LONG' ? 'badge-long' : 'badge-short'}">${pos.direction}</span>
                            <span style="min-width: 80px;">$${(pos.amount || 0).toFixed(2)}</span>
                            <span style="min-width: 100px;" class="${pnlClass}">${formatPnl(pnl)}</span>
                            <span style="color: var(--text-muted);">${formatTime(pos.opened_at)}</span>
                        </div>`;
                    }
                    posContainer.innerHTML = html;
                } else {
                    posContainer.innerHTML = '<div class="no-data">No open positions</div>';
                }
                
                // History
                document.getElementById('userHistCount').textContent = data.history_count || 0;
                const histContainer = document.getElementById('userHistory');
                if (data.history && data.history.length > 0) {
                    let html = '';
                    for (const trade of data.history) {
                        const pnl = parseFloat(trade.pnl || 0);
                        const pnlClass = pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
                        html += `<div class="log-entry">
                            <span style="min-width: 80px; color: var(--info);">${trade.symbol?.split('/')[0] || '-'}</span>
                            <span style="min-width: 60px;" class="badge ${trade.direction === 'LONG' ? 'badge-long' : 'badge-short'}">${trade.direction}</span>
                            <span style="min-width: 80px;">$${(trade.amount || 0).toFixed(2)}</span>
                            <span style="min-width: 100px;" class="${pnlClass}">${formatPnl(pnl)}</span>
                            <span style="min-width: 80px; color: var(--warning);">${trade.reason || '-'}</span>
                            <span style="color: var(--text-muted);">${formatTime(trade.closed_at)}</span>
                        </div>`;
                    }
                    histContainer.innerHTML = html;
                } else {
                    histContainer.innerHTML = '<div class="no-data">No trade history</div>';
                }
                
                // Logs
                const logsContainer = document.getElementById('userLogs');
                if (data.user_logs && data.user_logs.length > 0) {
                    let html = '';
                    for (const log of data.user_logs) {
                        html += `<div class="log-entry">
                            <span class="log-time">${log.timestamp || '-'}</span>
                            <span class="log-level ${log.level}">${log.level}</span>
                            <span style="min-width: 80px; color: var(--info);">${log.symbol || '-'}</span>
                            <span class="log-message">${escapeHtml(log.message || '-')}</span>
                        </div>`;
                    }
                    logsContainer.innerHTML = html;
                } else {
                    logsContainer.innerHTML = '<div class="no-data">No logs for this user</div>';
                }
            } catch (error) {
                console.error('Error looking up user:', error);
                alert('Error: ' + error.message);
            }
        }
        
        document.getElementById('userIdInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') lookupUser();
        });
        
        // Share
        async function shareStats() {
            document.getElementById('shareDate').textContent = formatTime24(new Date());
            document.getElementById('shareWinRate').textContent = (currentStats.win_rate || 0) + '%';
            
            const pnl = parseFloat(currentStats.total_pnl || 0);
            const sharePnlEl = document.getElementById('sharePnl');
            sharePnlEl.textContent = formatPnl(pnl);
            sharePnlEl.style.color = pnl >= 0 ? 'var(--positive)' : 'var(--negative)';
            
            document.getElementById('shareProfitable').textContent = currentStats.profitable || 0;
            document.getElementById('shareLosing').textContent = currentStats.losing || 0;
            
            const todayPnl = parseFloat(currentExtended.today_pnl || 0);
            const shareTodayEl = document.getElementById('shareTodayPnl');
            shareTodayEl.textContent = formatPnl(todayPnl);
            shareTodayEl.style.color = todayPnl >= 0 ? 'var(--positive)' : 'var(--negative)';
            
            document.getElementById('shareOpen').textContent = currentStats.positions_total || currentStats.open_deals || 0;
            
            const shareCard = document.getElementById('shareCard');
            shareCard.style.left = '0';
            shareCard.style.top = '0';
            shareCard.style.position = 'absolute';
            shareCard.style.zIndex = '-1';
            
            const shareBtn = document.getElementById('btnShare');
            const origShareText = shareBtn.innerHTML;
            
            try {
                const canvas = await html2canvas(shareCard, { backgroundColor: '#080c10', scale: 2 });
                canvas.toBlob(async (blob) => {
                    try {
                        await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
                    } catch (e) {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'yula-stats-' + new Date().toISOString().slice(0,10) + '.png';
                        a.click();
                        URL.revokeObjectURL(url);
                    }
                    // Show "Taken" on the button briefly
                    shareBtn.innerHTML = '‚úÖ Taken';
                    setTimeout(() => { shareBtn.innerHTML = origShareText; }, 2000);
                }, 'image/png');
            } catch (error) {
                console.error('Error creating screenshot:', error);
                shareBtn.innerHTML = '‚ùå Error';
                setTimeout(() => { shareBtn.innerHTML = origShareText; }, 2000);
            }
            
            shareCard.style.left = '-9999px';
        }
        
        // Refresh
        function refreshAll() {
            const btn = document.getElementById('btnRefresh');
            btn.classList.add('spinning');
            
            Promise.all([
                fetchStats(),
                fetchExtended(),
                fetchTrades(),
                fetchLogs(),
                fetchAlerts(),
                fetchPositions(),
                fetchNews()
            ]).finally(() => {
                setTimeout(() => btn.classList.remove('spinning'), 600);
            });
        }
        
        // Initial load
        refreshAll();
        
        // Auto-refresh intervals
        setInterval(fetchStats, 3000);
        setInterval(fetchExtended, 5000);
        setInterval(fetchTrades, 5000);
        setInterval(fetchLogs, 10000);
        setInterval(fetchAlerts, 15000);
        setInterval(fetchPositions, 5000);
        setInterval(fetchNews, 30000);
        
        // AI refresh - every 30 seconds if tab is active
        setInterval(() => {
            if (document.getElementById('tab-ai')?.classList.contains('active')) {
                fetchAI();
            }
        }, 30000);
    </script>
</body>
</html>
